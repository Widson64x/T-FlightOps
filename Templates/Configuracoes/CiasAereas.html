{% extends "Base.html" %}

{% block titulo %}Gestão de Parceiros Aéreos{% endblock %}

{% block conteudo %}
<div class="container-fluid" style="padding: 40px; max-width: 1000px; margin: 0 auto;">
    
    <div class="glass-header">
        <div class="header-text">
            <h2><i class="ph-duotone ph-airplane-tilt"></i> Índice de Prioridade (Parcerias)</h2>
            <p>Defina o nível de preferência. O sistema priorizará rotas com maior índice.</p>
        </div>
        <button class="btn-new" onclick="AbrirModalNovaCia()">
            <i class="ph-bold ph-plus"></i> Nova Cia
        </button>
    </div>

    <div class="glass-card">
        <div class="card-body">
            
            {% if Cias|length == 0 %}
            <div class="empty-state">
                <i class="ph-duotone ph-airplane"></i>
                <h3>Nenhuma companhia cadastrada</h3>
                <p>Cadastre manualmente ou importe uma malha aérea.</p>
            </div>
            {% endif %}

            <div class="partners-grid">
                {% for item in Cias %}
                <div class="partner-row">
                    <div class="partner-info">
                        <div class="logo-box">
                            <img src="/Luft-ConnectAir/Static/Img/Logos/{{ item.cia }}.png" onerror="this.src='https://placehold.co/40x40?text={{ item.cia[:2] }}'">
                        </div>
                        <span class="partner-name">{{ item.cia }}</span>
                    </div>

                    <div class="partner-control">
                        <input type="range" min="0" max="100" value="{{ item.score }}" 
                               class="score-range" 
                               id="range-{{ item.cia }}"
                               oninput="AtualizarLabel('{{ item.cia }}', this.value)"
                               onchange="SalvarPreferencia('{{ item.cia }}', this.value)">
                    </div>

                    <div class="partner-score">
                        <span id="lbl-{{ item.cia }}" class="score-badge score-{{ item.score // 20 }}">
                            {{ item.score }}%
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="modal-nova-cia" class="modal-backdrop hidden" onclick="FecharModalNovaCia(event)">
    <div class="glass-modal">
        <div class="modal-header">
            <h3>Cadastrar Companhia</h3>
            <button class="btn-close" onclick="FecharModalNovaCia(null)"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <div class="input-group">
                <label>Sigla / Nome da Cia</label>
                <input type="text" id="input-nova-cia" placeholder="Ex: LATAM, GOL, AZUL" maxlength="10">
            </div>
            <div class="input-group">
                <label>Score Inicial</label>
                <input type="range" id="input-novo-score" min="0" max="100" value="50" oninput="document.getElementById('lbl-novo-score').innerText = this.value + '%'">
                <div style="text-align: right; font-weight: bold; margin-top: 5px;" id="lbl-novo-score">50%</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="FecharModalNovaCia(null)">Cancelar</button>
            <button class="btn-confirm" onclick="SalvarNovaCia()">Salvar</button>
        </div>
    </div>
</div>

<style>
    /* Estilos Glass */
    .glass-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px;
    }
    .header-text h2 { margin: 0; color: var(--cor-texto-principal); display: flex; align-items: center; gap: 10px; }
    .header-text p { margin: 5px 0 0 0; color: var(--cor-texto-secundario); font-size: 0.9rem; }

    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .btn-new {
        background: var(--cor-primaria); color: white; border: none; padding: 10px 20px;
        border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        transition: transform 0.2s;
    }
    .btn-new:hover { transform: translateY(-2px); filter: brightness(1.1); }

    .partners-grid { display: flex; flex-direction: column; }
    .partner-row { display: flex; align-items: center; padding: 20px 30px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .partner-row:hover { background: rgba(0,0,0,0.02); }

    .partner-info { flex: 0 0 180px; display: flex; align-items: center; gap: 15px; }
    .logo-box { width: 40px; height: 40px; border-radius: 50%; background: white; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
    .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .partner-name { font-weight: 700; font-size: 1.1rem; }

    .partner-control { flex: 1; padding: 0 40px; }
    
    input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
        background: var(--cor-primaria); cursor: pointer; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%; height: 4px; cursor: pointer; background: rgba(0,0,0,0.1); border-radius: 2px;
    }

    .partner-score { flex: 0 0 80px; text-align: right; }
    .score-badge { font-weight: 800; padding: 5px 10px; border-radius: 8px; font-size: 1rem; display: inline-block; min-width: 60px; text-align: center; }
    .score-0, .score-1 { background: #fee2e2; color: #b91c1c; } 
    .score-2, .score-3 { background: #fef3c7; color: #b45309; } 
    .score-4, .score-5 { background: #dcfce7; color: #15803d; }

    .empty-state { text-align: center; padding: 50px; color: var(--cor-texto-secundario); }
    .empty-state i { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }

    /* Modal Styles */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 2000;
        display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
    
    .glass-modal {
        background: #fff; padding: 25px; border-radius: 16px; width: 400px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s;
    }
    .modal-backdrop.visible .glass-modal { transform: scale(1); }

    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .btn-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #555; font-weight: bold; }
    .input-group input[type=text] {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
    }
    
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-cancel { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
    .btn-confirm { padding: 8px 16px; border: none; background: var(--cor-primaria); color: #fff; border-radius: 6px; cursor: pointer; }
</style>

<script>
    // URL CORRETA GERADA PELO FLASK
    const API_SALVAR = "{{ url_for('Configuracoes.SalvarScoreCia') }}";

    function AtualizarLabel(cia, valor) {
        const lbl = document.getElementById(`lbl-${cia}`);
        lbl.innerText = valor + '%';
        lbl.className = 'score-badge';
        const nivel = Math.floor(valor / 20);
        lbl.classList.add(`score-${nivel}`);
    }

    function SalvarPreferencia(cia, valor) {
        fetch(API_SALVAR, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cia: cia, score: valor })
        })
        .then(r => r.json())
        .then(d => {
            if(!d.sucesso) alert('Erro ao salvar preferência.');
        })
        .catch(err => console.error(err));
    }

    // --- Lógica do Modal ---
    function AbrirModalNovaCia() {
        document.getElementById('input-nova-cia').value = '';
        const el = document.getElementById('modal-nova-cia');
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('visible'), 10);
    }

    function FecharModalNovaCia(e) {
        if (e && !e.target.classList.contains('modal-backdrop')) return;
        const el = document.getElementById('modal-nova-cia');
        el.classList.remove('visible');
        setTimeout(() => el.classList.add('hidden'), 300);
    }

    function SalvarNovaCia() {
        const nome = document.getElementById('input-nova-cia').value.trim().toUpperCase();
        const score = document.getElementById('input-novo-score').value;

        if(!nome) { alert('Digite o nome da Cia.'); return; }

        // Usa a mesma API para criar
        fetch(API_SALVAR, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cia: nome, score: score })
        })
        .then(r => r.json())
        .then(d => {
            if(d.sucesso) {
                location.reload(); // Recarrega para mostrar na lista
            } else {
                alert('Erro ao criar companhia.');
            }
        });
    }
</script>
{% endblock %}