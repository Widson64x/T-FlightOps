{% extends "Base.html" %}

{% block titulo %}Monitoramento Aéreo | FlightOps{% endblock %}

{% block conteudo %}
{% include "Components/_ModalCtc.html" %}

<style>
    /* --- VARIÁVEIS DO TEMA --- */
    :root {
        --kpi-bg: var(--cor-fundo-painel);
        --table-header-bg: #f8fafc;
        --table-row-hover: rgba(var(--cor-primaria-rgb), 0.03);
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --text-muted: #64748b;
    }
    
    /* Layout Principal */
    .monitoring-dashboard {
        display: flex; flex-direction: column; gap: 20px;
        height: calc(100vh - 100px);
    }

    /* --- CABEÇALHO --- */
    .dash-header {
        display: flex; justify-content: space-between; align-items: flex-end;
        padding-bottom: 20px; border-bottom: 1px solid var(--cor-borda);
    }
    .header-title h2 {
        font-size: 1.5rem; font-weight: 700; color: var(--cor-texto-principal);
        display: flex; align-items: center; gap: 12px; margin-bottom: 6px;
    }
    .header-subtitle {
        font-size: 0.9rem; color: var(--text-muted); font-weight: 500;
        display: flex; align-items: center; gap: 8px;
    }

    /* Badge Ao Vivo */
    .live-indicator {
        display: inline-flex; align-items: center; gap: 6px;
        background: rgba(16, 185, 129, 0.1); color: var(--success-color);
        padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .live-dot {
        width: 8px; height: 8px; background: var(--success-color); border-radius: 50%;
        animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green {
        0% { transform: scale(0.95); opacity: 1; }
        70% { transform: scale(1.4); opacity: 0; }
        100% { transform: scale(0.95); opacity: 0; }
    }

    /* Botão Principal */
    .btn-action-primary {
        background: var(--cor-texto-principal); color: white; padding: 12px 20px;
        border-radius: 8px; font-weight: 600; text-decoration: none;
        display: flex; align-items: center; gap: 10px; transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-action-primary:hover {
        transform: translateY(-2px); background: #000;
    }

    /* --- KPIS --- */
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .kpi-card {
        background: var(--kpi-bg); border: 1px solid var(--cor-borda);
        border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s;
    }
    .kpi-icon {
        width: 48px; height: 48px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
    }
    .icon-blue { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .icon-orange { background: rgba(249, 115, 22, 0.1); color: #f97316; }
    .icon-green { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    
    .kpi-info { display: flex; flex-direction: column; }
    .kpi-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: var(--text-muted); }
    .kpi-value { font-size: 1.4rem; font-weight: 700; color: var(--cor-texto-principal); margin-top: 2px; }

    /* --- BARRA DE FERRAMENTAS (NOVO) --- */
    .toolbar-container {
        display: flex; gap: 12px; align-items: center;
        margin-bottom: -10px; /* Aproxima da tabela */
    }
    .search-group {
        position: relative; flex: 1; max-width: 400px;
    }
    .search-group i {
        position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
        color: var(--text-muted); pointer-events: none;
    }
    .input-filter {
        width: 100%; padding: 10px 10px 10px 40px;
        border: 1px solid var(--cor-borda); border-radius: 8px;
        background: var(--cor-fundo-painel); color: var(--cor-texto-principal);
        font-size: 0.9rem; outline: none; transition: border 0.2s;
    }
    .input-filter:focus { border-color: var(--cor-primaria); }

    .select-filter {
        padding: 0 16px; height: 40px;
        border: 1px solid var(--cor-borda); border-radius: 8px;
        background: var(--cor-fundo-painel); color: var(--cor-texto-principal);
        font-size: 0.85rem; outline: none; cursor: pointer;
    }

    /* --- TABELA --- */
    .table-container {
        flex: 1; background: var(--cor-fundo-painel);
        border: 1px solid var(--cor-borda); border-radius: 12px;
        overflow: hidden; display: flex; flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    }
    .table-scroll-area { flex: 1; overflow: auto; }
    .flight-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }

    /* Ordenação nos Headers */
    .flight-table th {
        background: var(--table-header-bg); color: var(--text-muted);
        font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
        padding: 16px; text-align: left; position: sticky; top: 0; z-index: 10;
        border-bottom: 1px solid var(--cor-borda);
        cursor: pointer; user-select: none; transition: background 0.2s;
    }
    .flight-table th:hover { background: #f1f5f9; color: var(--cor-primaria); }
    .flight-table th i.sort-icon { margin-left: 5px; opacity: 0.3; font-size: 0.8rem; }
    .flight-table th.sorted-asc i.sort-icon, 
    .flight-table th.sorted-desc i.sort-icon { opacity: 1; color: var(--cor-primaria); }

    .flight-table td { padding: 14px 16px; border-bottom: 1px solid var(--cor-borda); color: var(--cor-texto-principal); vertical-align: middle; }
    .flight-table tr:hover td { background: var(--table-row-hover); }

    /* Colunas Específicas */
    .col-ctc { font-family: 'Monaco', monospace; font-weight: 700; color: var(--cor-primaria); }
    .col-route { font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .col-route i { color: var(--text-muted); font-size: 0.8rem; }
    .col-money { font-family: 'Monaco', monospace; font-weight: 600; text-align: right; color: var(--success-color); }
    
    .badge-prio { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .prio-urgent { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
    .prio-normal { background: rgba(100, 116, 139, 0.1); color: #64748b; border: 1px solid rgba(100, 116, 139, 0.2); }

    .btn-plan {
        width: 34px; height: 34px; border-radius: 8px;
        background: transparent; border: 1px solid var(--cor-borda); color: var(--text-muted);
        display: flex; align-items: center; justify-content: center; transition: 0.2s; text-decoration: none;
    }
    .btn-plan:hover { background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); transform: scale(1.05); }

    .new-row { animation: flash-row 1.5s ease-out; }
    @keyframes flash-row { 0% { background-color: rgba(16, 185, 129, 0.2); } 100% { background-color: transparent; } }
    
    .empty-state { text-align: center; padding: 60px; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .empty-state i { font-size: 3rem; color: var(--cor-borda); }
</style>

<div class="monitoring-dashboard">

    <div class="dash-header">
        <div class="header-title">
            <h2>
                Monitoramento de Cargas
                <div class="live-indicator"><div class="live-dot"></div>RT-10s</div>
            </h2>
            <div class="header-subtitle">
                <i class="ph-bold ph-calendar-blank"></i> <span id="data-extenso"></span>
                <span style="margin: 0 8px; color: var(--cor-borda);">|</span>
                <span id="contador-linhas">0 registros</span>
            </div>
        </div>

        <a href="{{ url_for('Planejamento.MapaGlobal') }}" class="btn-action-primary">
            <i class="ph-bold ph-globe-hemisphere-west"></i> Diário de Voos
        </a>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon icon-blue"><i class="ph-duotone ph-files"></i></div>
            <div class="kpi-info"><span class="kpi-label">Documentos Hoje</span><span class="kpi-value" id="kpi-docs">0</span></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon icon-orange"><i class="ph-duotone ph-scales"></i></div>
            <div class="kpi-info"><span class="kpi-label">Peso Taxado Total</span><span class="kpi-value" id="kpi-peso">0 kg</span></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon icon-green"><i class="ph-duotone ph-currency-dollar"></i></div>
            <div class="kpi-info"><span class="kpi-label">Faturamento Estimado</span><span class="kpi-value" id="kpi-fat">R$ 0,00</span></div>
        </div>
    </div>

    <div class="toolbar-container">
        <div class="search-group">
            <i class="ph-bold ph-magnifying-glass"></i>
            <input type="text" id="input-busca" class="input-filter" placeholder="Buscar CTC, Cidade, Cliente..." onkeyup="FiltrarTabela()">
        </div>
        
        <select id="filtro-prioridade" class="select-filter" onchange="FiltrarTabela()">
            <option value="TODOS">Todas Prioridades</option>
            <option value="URGENTE">⚠️ Apenas Urgentes</option>
            <option value="NORMAL">✅ Apenas Normais</option>
        </select>

        <select id="filtro-filial" class="select-filter" onchange="FiltrarTabela()">
            <option value="TODOS">Todas Filiais</option>
            </select>
    </div>

    <div class="table-container">
        <div class="table-scroll-area">
            <table class="flight-table">
                <thead>
                    <tr>
                        <th style="text-align: center; width: 60px;">Ação</th>
                        <th onclick="Ordenar('filial')" style="text-align: center; width: 80px;">Filial <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('ctc')" style="width: 120px;">CTC <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('data_raw')" style="width: 100px;">Emissão <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('prioridade')" style="text-align: center; width: 100px;">Prio <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th style="text-align: center;">LastMile</th>
                        <th style="width: 140px;">Rota</th>
                        <th>Remetente / Destinatário</th>
                        <th onclick="Ordenar('volumes')" style="text-align: right;">Vol. <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('qtd_notas')" style="text-align: right;">Qtd. Notas <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('raw_val_mercadoria')" style="text-align: right;">Valor da Mercadoria <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('peso_taxado')" style="text-align: right;">Peso <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                        <th onclick="Ordenar('raw_frete_total')" style="text-align: right;">Frete <i class="ph-bold ph-caret-up-down sort-icon"></i></th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr><td colspan="12"><div class="empty-state"><i class="ph-duotone ph-airplane-tilt"></i><span>Carregando dados...</span></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- LÓGICA INTELIGENTE (CLIENT-SIDE) ---
    
    // Configurações
    const URL_API = "{{ url_for('Planejamento.ApiCtcsHoje') }}";
    const URL_BASE_MONTAR = "{{ url_for('Planejamento.MontarPlanejamento', filial='__F__', serie='__S__', ctc='__C__') }}";
    
    // Estado Local
    let DADOS_ORIGINAIS = [];
    let DADOS_VISIVEIS = [];
    let VISTOS = new Set();
    let ORDEM_ATUAL = { col: 'data_raw', dir: 'desc' }; // Padrão: Mais recentes primeiro

    // Inicializa Data
    const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    document.getElementById('data-extenso').innerText = new Date().toLocaleDateString('pt-BR', opts);

    // Loop Principal
    BuscarDados();
    setInterval(BuscarDados, 10000);

    // 1. Busca Dados na API
    async function BuscarDados() {
        try {
            const resp = await fetch(URL_API);
            const dadosNovos = await resp.json();

            // Prepara dados para ordenação (Cria timestamp numérico)
            dadosNovos.forEach(d => {
                // Formato esperado emissao: DD/MM/YYYY e hora: HH:MM
                const partes = d.data_emissao.split('/');
                const horaLimpa = d.hora_emissao.replace(':', '');
                // Cria YYYYMMDDHHMM para ordenar corretamente
                d.data_raw = Number(`${partes[2]}${partes[1]}${partes[0]}${horaLimpa}`);
                
                // Campo composto para facilitar busca
                d.busca_texto = `${d.ctc} ${d.remetente} ${d.destinatario} ${d.origem} ${d.destino} ${d.filial}`.toLowerCase();
            });

            // Se for a primeira vez, popula o filtro de filiais
            if (DADOS_ORIGINAIS.length === 0) {
                PopularSelectFiliais(dadosNovos);
            }

            DADOS_ORIGINAIS = dadosNovos;
            
            // Reaplica filtros e renderiza (mantém o estado visual do usuário)
            FiltrarTabela();

        } catch (e) { console.error("Erro API:", e); }
    }

    // 2. Sistema de Filtros
    function FiltrarTabela() {
        const termo = document.getElementById('input-busca').value.toLowerCase();
        const prio = document.getElementById('filtro-prioridade').value;
        const filial = document.getElementById('filtro-filial').value;

        DADOS_VISIVEIS = DADOS_ORIGINAIS.filter(item => {
            const matchTexto = item.busca_texto.includes(termo);
            const matchPrio = (prio === 'TODOS') || (item.prioridade === prio);
            const matchFilial = (filial === 'TODOS') || (item.filial === filial);
            return matchTexto && matchPrio && matchFilial;
        });

        AplicarOrdenacao(); // Ordena os dados filtrados
        Renderizar();       // Desenha na tela
        AtualizarKPIs();    // Atualiza os cartões
    }

    // 3. Sistema de Ordenação
    function Ordenar(coluna) {
        // Inverte direção se clicar na mesma coluna
        if (ORDEM_ATUAL.col === coluna) {
            ORDEM_ATUAL.dir = ORDEM_ATUAL.dir === 'asc' ? 'desc' : 'asc';
        } else {
            ORDEM_ATUAL.col = coluna;
            ORDEM_ATUAL.dir = 'desc'; // Padrão descrescente para números/datas
        }

        // Atualiza ícones visuais (CSS classes)
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.getAttribute('onclick') && th.getAttribute('onclick').includes(coluna)) {
                th.classList.add(`sorted-${ORDEM_ATUAL.dir}`);
            }
        });

        FiltrarTabela(); // Re-executa o fluxo
    }

    function AplicarOrdenacao() {
        const col = ORDEM_ATUAL.col;
        const mult = ORDEM_ATUAL.dir === 'asc' ? 1 : -1;

        DADOS_VISIVEIS.sort((a, b) => {
            let valA = a[col];
            let valB = b[col];

            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();

            if (valA < valB) return -1 * mult;
            if (valA > valB) return 1 * mult;
            return 0;
        });
    }

    // 4. Renderização HTML
    function Renderizar() {
        const tbody = document.getElementById('table-body');
        document.getElementById('contador-linhas').innerText = `${DADOS_VISIVEIS.length} registros`;

        if (DADOS_VISIVEIS.length === 0) {
            tbody.innerHTML = `<tr><td colspan="12"><div class="empty-state"><i class="ph-duotone ph-magnifying-glass"></i><span>Nenhum registro encontrado com os filtros atuais.</span></div></td></tr>`;
            return;
        }

        const html = DADOS_VISIVEIS.map(r => {
            // Verifica se é item novo para animar
            const novo = !VISTOS.has(r.id_unico);
            if (novo) VISTOS.add(r.id_unico);
            const classeAnim = novo ? 'new-row' : '';
            
            const badgeClass = r.prioridade === 'URGENTE' ? 'prio-urgent' : 'prio-normal';
            const link = URL_BASE_MONTAR.replace('__F__', r.filial).replace('__S__', r.serie).replace('__C__', r.ctc);

            return `
            <tr class="${classeAnim}">
                <td style="text-align:center;">
                    <div style="display:flex; justify-content:center; gap:5px;">
                        <a href="${link}" class="btn-plan" title="Planejar Rota">
                            <i class="ph-bold ph-airplane-takeoff"></i>
                        </a>
                        <button class="btn-plan" onclick="AbrirModalGlobal('${r.filial}', '${r.serie}', '${r.ctc}')" title="Ver Documento Completo">
                            <i class="ph-bold ph-file-text"></i>
                        </button>
                    </div>
                </td>

                <td style="text-align:center; font-weight: 600;">${r.filial}</td>
                <td class="col-ctc">${r.ctc}</td>
                <td>
                    <div style="font-weight: 600;">${r.hora_emissao}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${r.data_emissao.substring(0,5)}</div>
                </td>
                <td style="text-align:center;"><span class="badge-prio ${badgeClass}">${r.prioridade || 'NOR'}</span></td>
                <td style="text-align:center; font-weight:600; color:#555;">${r.unid_lastmile}</td>
                <td>
                    <div class="col-route">${r.origem} <i class="ph-bold ph-arrow-right"></i> ${r.destino}</div>
                </td>
                <td>
                    <div style="font-size: 0.8rem; font-weight:600;">${r.remetente.substring(0,15)}...</div>
                    <div style="font-size: 0.75rem; color:var(--text-muted);">${r.destinatario.substring(0,15)}...</div>
                </td>
                <td style="text-align:right;">${r.volumes}</td>
                <td style="text-align:right;">${r.qtd_notas}</td>
                <td style="text-align:right; font-weight:600;">${r.val_mercadoria}</td>
                <td style="text-align:right;">${r.peso_taxado.toLocaleString('pt-BR')} kg</td>
                <td class="col-money">${r.raw_frete_total}</td>
            </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // 5. Atualização de Totais (KPIs) baseados no Filtro
    function AtualizarKPIs() {
        const totalDocs = DADOS_VISIVEIS.length;
        // Soma usando os valores raw (números)
        const totalPeso = DADOS_VISIVEIS.reduce((acc, curr) => acc + (curr.peso_taxado || 0), 0);
        const totalFat = DADOS_VISIVEIS.reduce((acc, curr) => acc + (curr.raw_frete_total || 0), 0);

        document.getElementById('kpi-docs').innerText = totalDocs;
        document.getElementById('kpi-peso').innerText = totalPeso.toLocaleString('pt-BR', {maximumFractionDigits:0}) + ' kg';
        document.getElementById('kpi-fat').innerText = totalFat.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

    // 6. Auxiliar: Popula Select de Filiais
    function PopularSelectFiliais(dados) {
        const filiais = [...new Set(dados.map(d => d.filial))].sort();
        const select = document.getElementById('filtro-filial');
        
        // Limpa opções antigas (exceto "Todos")
        while (select.options.length > 1) { select.remove(1); }

        filiais.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f; opt.innerText = `Filial ${f}`;
            select.appendChild(opt);
        });
    }

</script>
{% endblock %}