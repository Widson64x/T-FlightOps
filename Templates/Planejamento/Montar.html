{% extends "Base.html" %}

{% block titulo %}Planejamento Visual | FlightOps{% endblock %}

{% block conteudo %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* --- TEMA GLASSMORPHISM (CLEAN & MODERNO) --- */
    :root {
        --cor-primaria: #0d6efd;
        --cor-sucesso: #198754;
        --bg-glass: rgba(255, 255, 255, 0.95);
        --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        --border-glass: 1px solid rgba(255, 255, 255, 0.18);
        --font-main: 'Inter', system-ui, sans-serif;
    }

    body { margin: 0; overflow: hidden; }

    .page-container {
        position: relative;
        height: calc(100vh - 70px);
        width: 100%;
        background: #eef2f3;
        font-family: var(--font-main);
    }

    #map { width: 100%; height: 95%; z-index: 1; background: #cad2d3; }

    /* --- SIDEBAR FLUTUANTE --- */
    .sidebar-float {
        position: absolute; top: 20px; left: 20px; bottom: 20px; width: 400px;
        height: 85%;
        background: var(--bg-glass); backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 16px; border: var(--border-glass);
        box-shadow: var(--shadow-glass);
        z-index: 1000; display: flex; flex-direction: column;
        transition: transform 0.3s ease;
    }

    /* Header */
    .sidebar-header {
        padding: 25px;
        background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(240,240,240,0.8));
        border-radius: 16px 16px 0 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .badge-filial { background: #333; color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .ctc-numero { font-size: 1.8rem; font-weight: 800; color: #1a1a1a; letter-spacing: -1px; margin: 0; }
    .ctc-data { font-size: 0.85rem; color: #666; display: flex; align-items: center; gap: 5px; margin-top: 5px; }

    /* KPIs */
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .kpi-card {
        background: #fff; padding: 12px; border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05);
        display: flex; flex-direction: column;
    }
    .kpi-lbl { font-size: 0.7rem; color: #999; text-transform: uppercase; font-weight: 600; }
    .kpi-val { font-size: 1rem; font-weight: 700; color: #333; margin-top: 2px; }
    .kpi-money { color: var(--cor-sucesso); }

    /* TIMELINE */
    .timeline-area { flex: 1; overflow-y: auto; padding: 25px; }
    
    .step { display: flex; gap: 18px; padding-bottom: 35px; position: relative; opacity: 0.5; transition: all 0.5s; }
    .step.active { opacity: 1; transform: translateX(5px); }
    
    .step::before {
        content: ''; position: absolute; left: 20px; top: 45px; bottom: 0;
        width: 2px; background: #e0e0e0; z-index: 0;
    }
    .step:last-child::before { display: none; }

    .step-icon {
        width: 42px; height: 42px; background: #fff; border: 2px solid #ddd;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 20px; z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: all 0.3s;
    }
    .step.active .step-icon {
        border-color: var(--cor-primaria); color: var(--cor-primaria);
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15); transform: scale(1.1);
    }

    .step-info strong { display: block; font-size: 1rem; color: #333; margin-bottom: 2px; }
    .step-info span { font-size: 0.85rem; color: #666; }

    /* Card de Voo */
    .flight-card {
        background: #fff; border-left: 4px solid #ccc; padding: 15px;
        border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }
    .flight-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 700; font-size: 0.95rem; }
    .flight-route { display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; }
    
    /* POPUP CUSTOMIZADO */
    .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .leaflet-popup-content { margin: 0; width: 300px !important; }
    
    .pop-header {
        background: #1a1a1a; color: white; padding: 15px;
        font-weight: 700; font-size: 1rem; border-bottom: 3px solid var(--cor-primaria);
    }
    .pop-body { padding: 15px; background: #fff; }
    .pop-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.85rem;
    }
    .pop-row:last-child { border-bottom: none; }
    .pop-label { color: #888; }
    .pop-val { font-weight: 600; color: #333; text-align: right; max-width: 160px; }

</style>

<div class="page-container">
    
    <div class="sidebar-float">
        <div class="sidebar-header">
            <div class="header-top">
                <span class="badge-filial">FILIAL {{ Ctc.filial }}</span>
                <span style="font-size:0.8rem; color:#888;">S√âRIE {{ Ctc.serie }}</span>
            </div>
            <h1 class="ctc-numero">CTC {{ Ctc.ctc }}</h1>
            <div class="ctc-data">
                üìÖ Emiss√£o: {{ Ctc.data_emissao_real.strftime('%d/%m/%Y √†s %H:%M') }}
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-lbl">Volumes</span>
                    <span class="kpi-val">{{ Ctc.volumes }} cx</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-lbl">Peso Real</span>
                    <span class="kpi-val">{{ Ctc.peso }} kg</span>
                </div>
                <div class="kpi-card" style="grid-column: span 2; background: #f8fff9; border-color: #c3e6cb;">
                    <span class="kpi-lbl" style="color:#198754;">Valor da Carga</span>
                    <span class="kpi-val kpi-money">R$ {{ "{:,.2f}".format(Ctc.valor) }}</span>
                </div>
            </div>
        </div>

        <div class="timeline-area">
            <div class="step active" id="step-1">
                <div class="step-icon">üöõ</div>
                <div class="step-info">
                    <strong>Coleta na Origem</strong>
                    <span>{{ Origem.nome }} - {{ Origem.uf }}</span>
                </div>
            </div>

            <div class="step" id="step-2">
                <div class="step-icon">‚úàÔ∏è</div>
                <div class="step-info" style="width: 100%;">
                    <strong>Malha A√©rea</strong>
                    {% if Rotas %}
                        {% for voo in Rotas %}
                        <div class="flight-card" id="card-{{ loop.index0 }}">
                            <div class="flight-header">
                                <span id="cia-{{ loop.index0 }}">{{ voo.cia }} {{ voo.voo }}</span>
                                <span style="font-weight:400; font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;">{{ voo.data }}</span>
                            </div>
                            <div class="flight-route">
                                <span>üõ´ {{ voo.origem.iata }} <b>{{ voo.horario_saida }}</b></span>
                                <span>üõ¨ {{ voo.destino.iata }} <b>{{ voo.horario_chegada }}</b></span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="flight-card" style="border-left-color: #dc3545; background: #fff5f5; color:#dc3545;">
                            <strong>N√£o planejado</strong><br>
                            <small>Nenhum voo compat√≠vel encontrado.</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="step" id="step-3">
                <div class="step-icon">üèÅ</div>
                <div class="step-info">
                    <strong>Entrega Final</strong>
                    <span>{{ Destino.nome }} - {{ Destino.uf }}</span>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>
</div>

<script>
    /**
     * ====================================================================
     * PLUGIN MOVING MARKER EMBUTIDO (Para corrigir erro 404/MIME)
     * ====================================================================
     */
    L.interpolatePosition=function(t,i,n,o){var e=o/n;e=e>0?e:0,e=e>1?1:e;return L.latLng(t.lat+e*(i.lat-t.lat),t.lng+e*(i.lng-t.lng))};L.Marker.MovingMarker=L.Marker.extend({initialize:function(t,i,n){L.Marker.prototype.initialize.call(this,t[0],n),this._latlngs=t.map(t=>L.latLng(t)),this._durations=i,this._currentDuration=0,this._currentIndex=0,this._state=null,this._startTime=0,this._startTimeStamp=0,this._pauseStartTime=0,this._animId=0,this._animRequested=!1,this._currentLine=[]},isRunning:function(){return"run"===this._state},isPaused:function(){return"paused"===this._state},isEnded:function(){return"ended"===this._state},start:function(){this.isRunning()||(this.isPaused()?this.resume():(this._loadLine(0),this._startAnimation(),this.fire("start")))},resume:function(){this.isPaused()&&(this._currentLine[0]=this.getLatLng(),this._currentDuration-=this._pauseStartTime-this._startTime,this._startAnimation())},pause:function(){this.isRunning()&&(this._pauseStartTime=Date.now(),this._state="paused",this._stopAnimation(),this._updatePosition())},stop:function(t){this.isEnded()||(this._stopAnimation(),void 0===t&&(t=0,this._updatePosition()),this._state="ended",this.fire("end",{elapsedTime:t}))},_startAnimation:function(){this._state="run",this._animId=L.Util.requestAnimFrame(function(t){this._startTime=Date.now(),this._startTimeStamp=t,this._animate(t)},this),this._animRequested=!0},_stopAnimation:function(){this._animRequested&&(L.Util.cancelAnimFrame(this._animId),this._animRequested=!1)},_loadLine:function(t){this._currentIndex=t,this._currentDuration=this._durations[t],this._currentLine=[this._latlngs[t],this._latlngs[t+1]]},_updatePosition:function(){var t=Date.now()-this._startTime;this._animate(this._startTimeStamp+t,!0)},_animate:function(t,i){this._animRequested=!1;var n=Date.now()-this._startTime,o=this._currentDuration;if(n<o){var e=L.interpolatePosition(this._currentLine[0],this._currentLine[1],o,n);this.setLatLng(e),i||(this._animId=L.Util.requestAnimFrame(this._animate,this),this._animRequested=!0)}else this.setLatLng(this._currentLine[1]),this._currentIndex<this._latlngs.length-2?(this._loadLine(this._currentIndex+1),this._startAnimation()):(this._state="ended",this.fire("end",{elapsedTime:n}))},addLatLng:function(t,i){this._latlngs.push(L.latLng(t)),this._durations.push(i)},moveTo:function(t,i){this._stopAnimation(),this._latlngs=[this.getLatLng(),L.latLng(t)],this._durations=[i],this.start()}});L.Marker.movingMarker=function(t,i,n){return new L.Marker.MovingMarker(t,i,n)};
    /* FIM DO PLUGIN EMBUTIDO */


    // --- L√ìGICA DO SISTEMA ---
    const ctc = {{ Ctc | tojson | safe }};
    const rotas = {{ Rotas | tojson | safe }};
    const origem = { lat: {{ Origem.lat | default(0) }}, lon: {{ Origem.lon | default(0) }} };
    const destino = { lat: {{ Destino.lat | default(0) }}, lon: {{ Destino.lon | default(0) }} };

    const CORES = { 
        'LATAM': '#e60000', 'LA': '#e60000', 
        'AZUL': '#0055a4', 'AD': '#0055a4', 
        'GOL': '#ff6600', 'G3': '#ff6600', 
        'PADRAO': '#333' 
    };

    let map;
    let markerAnim = null;

    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Mapa Clean
        map = L.map('map', {zoomControl: false}).setView([-14.2, -51.9], 4);
        L.control.zoom({position: 'topright'}).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'FlightOps', maxZoom: 18
        }).addTo(map);

        // 2. √çcones Fixos
        const iconOrigem = L.divIcon({html: '<div style="font-size:28px;">üì¶</div>', className: 'dummy', iconSize:[30,30], iconAnchor:[15,15]});
        const iconDestino = L.divIcon({html: '<div style="font-size:28px;">üèÅ</div>', className: 'dummy', iconSize:[30,30], iconAnchor:[15,15]});

        // 3. Popup Rico (Com todos os dados)
        const htmlPopup = `
            <div class="pop-header">CTC ${ctc.ctc}</div>
            <div class="pop-body">
                <div class="pop-row"><span class="pop-label">Remetente</span> <span class="pop-val">${ctc.remetente.substring(0,20)}</span></div>
                <div class="pop-row"><span class="pop-label">Destinat√°rio</span> <span class="pop-val">${ctc.destinatario.substring(0,20)}</span></div>
                <div class="pop-row"><span class="pop-label">Nota Fiscal</span> <span class="pop-val">${ctc.nfs || '-'}</span></div>
                <div class="pop-row"><span class="pop-label">Esp√©cie</span> <span class="pop-val">${ctc.especie || 'VOL'}</span></div>
                <div class="pop-row"><span class="pop-label">Volumes</span> <span class="pop-val">${ctc.volumes}</span></div>
                <div class="pop-row"><span class="pop-label">Peso Taxado</span> <span class="pop-val">${ctc.peso} kg</span></div>
            </div>
        `;

        if(origem.lat) L.marker([origem.lat, origem.lon], {icon: iconOrigem}).addTo(map).bindPopup(htmlPopup);
        if(destino.lat) L.marker([destino.lat, destino.lon], {icon: iconDestino}).addTo(map).bindPopup("<b>Destino Final</b><br>{{ Destino.nome }}");

        // 4. Desenha Rotas e Configura Anima√ß√£o
        if(rotas && rotas.length > 0) {
            const layers = L.featureGroup();
            let pontosAnimacao = []; 
            
            let pontoAtual = [origem.lat, origem.lon];
            pontosAnimacao.push({loc: pontoAtual, duracao: 0, tipo: 'inicio'});

            rotas.forEach((voo, i) => {
                const pAeroO = [voo.origem.lat, voo.origem.lon];
                const pAeroD = [voo.destino.lat, voo.destino.lon];
                
                let cor = CORES['PADRAO'];
                if(voo.cia.includes('AZUL') || voo.cia.includes('AD')) cor = CORES['AZUL'];
                else if(voo.cia.includes('LATAM') || voo.cia.includes('LA')) cor = CORES['LATAM'];
                else if(voo.cia.includes('GOL') || voo.cia.includes('G3')) cor = CORES['GOL'];

                // Atualiza Sidebar
                const card = document.getElementById('card-'+i);
                if(card) {
                    card.style.borderLeftColor = cor;
                    document.getElementById('cia-'+i).style.color = cor;
                }

                // 1. Road (Tracejado) - BEM LENTO (8s)
                if(i===0) {
                    L.polyline([pontoAtual, pAeroO], {color:'#888', dashArray:'8,8', weight:3}).addTo(layers);
                    pontosAnimacao.push({loc: pAeroO, duracao: 8000, tipo: 'road'}); 
                }

                // 2. Air (S√≥lido) - ULTRA LENTO E SUAVE (15s)
                L.polyline([pAeroO, pAeroD], {color: cor, weight: 4}).addTo(layers);
                L.circleMarker(pAeroO, {radius:4, color:cor, fillColor:'white', fillOpacity:1}).addTo(layers).bindTooltip(voo.origem.iata);
                L.circleMarker(pAeroD, {radius:4, color:cor, fillColor:'white', fillOpacity:1}).addTo(layers).bindTooltip(voo.destino.iata);
                
                pontosAnimacao.push({loc: pAeroD, duracao: 15000, tipo: 'air', cor: cor}); 

                pontoAtual = pAeroD;
            });

            // 3. Road Final - BEM LENTO (8s)
            const pFinal = [destino.lat, destino.lon];
            L.polyline([pontoAtual, pFinal], {color:'#888', dashArray:'8,8', weight:3}).addTo(layers);
            pontosAnimacao.push({loc: pFinal, duracao: 8000, tipo: 'road'});

            layers.addTo(map);
            
            // Zoom inicial com margem
            setTimeout(() => map.fitBounds(layers.getBounds(), {padding: [100, 100]}), 500);

            // GATILHO AUTOM√ÅTICO DO LOOP
            window.dadosAnimacao = pontosAnimacao;
            // Delay inicial
            setTimeout(IniciarLoop, 2000);
        }
    });

    // --- FUN√á√ÉO DE LOOP INFINITO (SUAVE) ---
    function IniciarLoop() {
        if(!window.dadosAnimacao) return;

        const pontos = window.dadosAnimacao;
        let index = 0;

        // √çcones M√≥veis
        const iconTruck = L.divIcon({html: '<div style="font-size:32px;">üöö</div>', className: 'dummy', iconSize:[30,30], iconAnchor:[15,15]});
        const iconPlane = L.divIcon({html: '<div style="font-size:32px; transform: rotate(-45deg);">‚úàÔ∏è</div>', className: 'dummy', iconSize:[30,30], iconAnchor:[15,15]});

        // Limpa anterior
        if (markerAnim) markerAnim.remove();

        // Cria marcador
        markerAnim = L.Marker.movingMarker(
            [pontos[0].loc], 
            [1000], 
            {icon: iconTruck, zIndexOffset: 2000}
        ).addTo(map);

        // Torna o √≠cone animado clic√°vel tamb√©m!
        const popupInfo = `
            <div class="pop-header" style="background:#212529;">Carga em Tr√¢nsito</div>
            <div class="pop-body">
                <div class="pop-row"><span class="pop-label">Volume</span> <span class="pop-val">${ctc.volumes} vol</span></div>
                <div class="pop-row"><span class="pop-label">Peso</span> <span class="pop-val">${ctc.peso} kg</span></div>
            </div>
        `;
        markerAnim.bindPopup(popupInfo, {className: 'custom-popup'});

        function AnimarProximo() {
            // Fim -> Reinicia
            if (index >= pontos.length - 1) {
                setTimeout(() => {
                    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                    document.getElementById('step-1').classList.add('active'); 
                    IniciarLoop(); 
                }, 4000); // 4s de pausa no fim
                return;
            }

            const pProx = pontos[index+1];
            
            // Controle Sidebar
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            if (pProx.tipo === 'air') {
                markerAnim.setIcon(iconPlane);
                document.getElementById('step-2').classList.add('active');
            } else {
                markerAnim.setIcon(iconTruck);
                if(index === 0) document.getElementById('step-1').classList.add('active'); 
                else document.getElementById('step-3').classList.add('active');
            }

            // Move
            markerAnim.moveTo(pProx.loc, pProx.duracao);

            markerAnim.once('end', function() {
                // Pausa nas conex√µes (2s)
                setTimeout(() => {
                    index++;
                    AnimarProximo();
                }, 2000);
            });
        }

        AnimarProximo();
    }

</script>
{% endblock %}