{% extends "Base.html" %}

{% block titulo %}Torre de Controle Global | Luft-ConnectAir{% endblock %}

{% block conteudo %}
{% include "Components/_ModalCtc.html" %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
    /* --- ESTRUTURA ORIGINAL --- */
    .page-grid {
        display: grid; grid-template-columns: 380px 1fr; gap: 20px;
        height: calc(100vh - 140px); min-height: 550px; font-family: 'Inter', sans-serif;
    }
    .painel {
        background: var(--cor-fundo-painel, #fff); border: 1px solid var(--cor-borda, #dee2e6); 
        border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
        box-shadow: var(--sombra-card, 0 4px 12px rgba(0,0,0,0.05));
    }
    #map-wrapper {
        border-radius: 8px; border: 1px solid var(--cor-borda, #dee2e6);
        position: relative; height: 100%; width: 100%; overflow: hidden; background: #e9ecef;
    }
    #map { width: 100%; height: 100%; z-index: 1; }

    /* --- ESTILOS DO PAINEL LATERAL --- */
    .painel-top { 
        padding: 16px; 
        background: var(--cor-fundo-principal, #f8f9fa); 
        border-bottom: 1px solid var(--cor-borda, #eee);
        display: flex; flex-direction: column; gap: 12px;
    }
    .painel-header h5 { margin: 0; font-weight: 700; color: var(--cor-texto-principal, #333); font-size: 1rem; }
    .painel-header small { color: var(--cor-texto-secundario, #666); font-size: 0.8rem; }

    .painel-content { padding: 15px; flex: 1; overflow-y: auto; background: var(--cor-fundo-painel, #fdfdfd); }

    /* --- BOTÕES DE FILTRO (Estilo Tab) --- */
    .tabs-container {
        display: flex; 
        background: #fff; 
        border: 1px solid #dee2e6;
        padding: 4px; border-radius: 8px; gap: 4px;
        justify-content: space-between;
    }
    
    .tab-btn {
        flex: 1;
        background: transparent; border: none; border-radius: 6px;
        padding: 6px 4px; cursor: pointer; font-weight: 600; font-size: 11px;
        color: #64748b; 
        display: flex; align-items: center; justify-content: center; gap: 4px;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .tab-btn:hover { background: #f1f5f9; color: #334155; }
    
    .tab-btn.active {
        background: rgba(59, 130, 246, 0.1); /* Azul claro */
        color: #2563eb; /* Azul forte */
    }
    .tab-btn i { font-size: 14px; }

    /* Card CTC */
    .ctc-card {
        background: var(--cor-fundo-painel, #fff); border: 1px solid var(--cor-borda, #eee);
        border-radius: 10px; padding: 15px; margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; position: relative;
    }
    .ctc-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--cor-primaria, #0056b3); }
    .ctc-card.urgente { border-left: 4px solid #dc3545; }
    .ctc-card.normal { border-left: 4px solid var(--cor-primaria, #0056b3); }

    .card-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .badge-serie { background: #f1f3f5; color: #495057; padding: 3px 8px; border-radius: 6px; font-family: monospace; font-weight: bold; font-size: 0.8rem; }
    .badge-urg { background: #ffebeb; color: #dc3545; font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase;}

    .rota-display { font-weight: 700; color: var(--cor-texto-principal, #333); margin-bottom: 5px; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
    .seta-display { color: #adb5bd; font-size: 0.8rem; }

    .cliente-display { font-size: 0.8rem; color: #666; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .card-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 12px; }
    .stat-box { background: var(--cor-fundo-principal, #f8f9fa); padding: 6px; border-radius: 6px; text-align: center; }
    .stat-label { font-size: 0.65rem; color: #888; display: block; }
    .stat-val { font-size: 0.85rem; font-weight: 600; color: #333; }
    .stat-money { color: #198754; }

    /* Botões de Ação */
    .card-actions { display: grid; grid-template-columns: 1fr 40px; gap: 8px; }
    
    .btn-planejar {
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; padding: 8px; border-radius: 6px;
        background: transparent; border: 1px solid var(--cor-primaria, #0056b3);
        color: var(--cor-primaria, #0056b3); font-weight: 600; text-decoration: none;
        font-size: 0.9rem; transition: 0.2s;
    }
    .btn-planejar:hover { background: var(--cor-primaria, #0056b3); color: white; }

    .btn-detalhes {
        display: flex; align-items: center; justify-content: center;
        border-radius: 6px; background: #f8f9fa; border: 1px solid #dee2e6;
        color: #666; cursor: pointer; transition: 0.2s;
    }
    .btn-detalhes:hover { background: #e9ecef; color: #333; border-color: #ced4da; }

    /* --- MODAL DE DETALHES --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); z-index: 10000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-box {
        background: white; width: 90%; max-width: 800px; max-height: 90vh;
        border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header {
        padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        background: #f8f9fa;
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: #333; }
    .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
    .btn-close:hover { color: #333; }
    
    .modal-body { padding: 0; overflow-y: auto; }
    
    /* Tabela do Modal */
    .details-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .details-table th, .details-table td { padding: 10px 20px; border-bottom: 1px solid #eee; text-align: left; }
    .details-table th { background: #fdfdfd; color: #666; width: 30%; font-weight: 600; }
    .details-table td { color: #333; font-family: monospace; }
    .details-table tr:nth-child(even) { background: #fafafa; }

    /* Markers */
    .map-marker { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s; }
    .map-marker:hover { transform: scale(1.1); z-index: 9999 !important; }
    .marker-bubble {
        width: 100%; height: 100%; background: white; border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); border: 2px solid white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        overflow: hidden; position: relative;
    }
    .marker-header { width: 100%; color: white; font-weight: 800; font-size: 13px; padding: 3px 0; text-align: center; position: absolute; top: 0; }
    .bg-blue { background: var(--cor-primaria, #0056b3); }
    .bg-red { background: #dc3545; }
    .marker-body { margin-top: 18px; display: flex; flex-direction: column; align-items: center; line-height: 1.1; color: #333; }
    .marker-docs { font-weight: 900; font-size: 15px; }
    .marker-vols { font-size: 10px; color: #666; }
    .marker-value { font-size: 11px; font-weight: 700; color: #198754; margin-top: 2px; background: #e8f5e9; padding: 1px 5px; border-radius: 8px; }
    .map-marker.is-urgente .marker-bubble { border-color: #ffc9c9; }
    .map-marker.is-urgente::before { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; border-radius: 50%; border: 2px solid #dc3545; animation: pulse-radar 2s infinite; opacity: 0; z-index: -1; }
    @keyframes pulse-radar { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1.4); opacity: 0; } }
    .empty-state { text-align: center; padding: 40px; color: #adb5bd; }
</style>

<div class="page-grid">
    <div class="painel">
        <div class="painel-top">
            <div class="painel-header">
                <h5><i class="bi bi-radar"></i> Expedição Aérea</h5>
                <small>Selecione um filtro e um cluster</small>
            </div>
            
            <div class="tabs-container">
                <button class="tab-btn active" onclick="MudarFiltroMapa('TODOS')" id="btn-todos">
                    <i class="ph-bold ph-squares-four"></i> Global
                </button>
                <button class="tab-btn" onclick="MudarFiltroMapa('DIARIO')" id="btn-diario">
                    <i class="ph-bold ph-sun"></i> Do Dia
                </button>
                <button class="tab-btn" onclick="MudarFiltroMapa('BACKLOG')" id="btn-backlog">
                    <i class="ph-bold ph-clock-counter-clockwise"></i> Backlog
                </button>
                <button class="tab-btn" onclick="MudarFiltroMapa('REVERSA')" id="btn-reversa">
                    <i class="ph-bold ph-arrow-u-up-left"></i> Reversa
                </button>
            </div>
        </div>
        
        <div id="lista-ctcs" class="painel-content">
            <div class="empty-state">
                <i class="bi bi-map-fill" style="font-size: 2.5rem; display:block; margin-bottom:10px;"></i>
                Clique em uma região para ver detalhes.
            </div>
        </div>
    </div>
    <div id="map-wrapper">
        <div id="map"></div>
    </div>
</div>

<div id="modal-detalhes" class="modal-overlay" onclick="FecharModal(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">
                <i class="bi bi-file-text"></i> Detalhes do CTC: <span id="modal-ctc-id"></span>
            </div>
            <button class="btn-close" onclick="FecharModal(null)">&times;</button>
        </div>
        <div class="modal-body">
            <table class="details-table" id="tabela-detalhes">
            </table>
        </div>
    </div>
</div>

<script>
    // Dados originais vindo do Backend
    const DADOS_COMPLETOS = {{ Dados | tojson | safe }};
    const URL_BASE_MONTAR = "{{ url_for('Planejamento.MontarPlanejamento', filial='__FIL__', serie='__SER__', ctc='__NUM__') }}";
    
    let map;
    let markersLayer; // Grupo de marcadores para poder limpar depois
    let FILTRO_ATUAL = 'TODOS';

    const fmtShortMoney = (val) => {
        if (!val) return 'R$ 0';
        if (val >= 1000000) return 'R$ ' + (val / 1000000).toFixed(1).replace('.', ',') + 'M';
        if (val >= 1000) return 'R$ ' + (val / 1000).toFixed(0) + 'k';
        return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
    };

    document.addEventListener("DOMContentLoaded", function() {
        map = L.map('map', {zoomControl: false}).setView([-15.7, -52], 4);
        L.control.zoom({position: 'topright'}).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Luft-ConnectAir', maxZoom: 18
        }).addTo(map);

        // Cria o grupo de camadas para gerenciar os marcadores
        markersLayer = L.layerGroup().addTo(map);

        // Renderiza inicial (Todos)
        RenderizarMapa('TODOS');
    });

    // --- FUNÇÃO PRINCIPAL DE FILTRO ---
    function MudarFiltroMapa(tipo) {
        FILTRO_ATUAL = tipo;

        // Atualiza estilo dos botões
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${tipo.toLowerCase()}`).classList.add('active');

        // Renderiza o mapa novamente
        RenderizarMapa(tipo);

        // Limpa a sidebar para evitar confusão
        document.getElementById('lista-ctcs').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-funnel" style="font-size: 2.5rem; display:block; margin-bottom:10px;"></i>
                Filtro aplicado: <b>${tipo}</b>.<br>Selecione um cluster.
            </div>`;
    }

    function RenderizarMapa(filtro) {
        markersLayer.clearLayers(); // Remove marcadores antigos

        DADOS_COMPLETOS.forEach(est => {
            // 1. Filtra a lista de CTCs dentro deste estado
            const listaFiltrada = est.lista_ctcs.filter(ctc => {
                if (filtro === 'TODOS') return true;
                return ctc.origem_dados === filtro; // 'DIARIO', 'BACKLOG', 'REVERSA'
            });

            // Se não sobrar nada, não desenha o marcador
            if (listaFiltrada.length === 0) return;

            // 2. Recalcula os totais para o Bubble (Marcador)
            const qtdDocs = listaFiltrada.length;
            const valorTotal = listaFiltrada.reduce((acc, cur) => acc + (cur.raw_val_mercadoria || 0), 0);
            const qtdVols = listaFiltrada.reduce((acc, cur) => acc + (cur.volumes || 0), 0);
            const temUrgencia = listaFiltrada.some(c => c.eh_urgente);

            // 3. Cria o Marcador Visual
            const cssClass = temUrgencia ? 'map-marker is-urgente' : 'map-marker';
            const headerClass = temUrgencia ? 'bg-red' : 'bg-blue';
            const size = 90; 

            const iconHtml = `
                <div class="marker-bubble">
                    <div class="marker-header ${headerClass}">${est.uf}</div>
                    <div class="marker-body">
                        <div class="marker-docs">${qtdDocs}</div>
                        <div class="marker-vols">${qtdVols} vol</div>
                        <div class="marker-value">${fmtShortMoney(valorTotal)}</div>
                    </div>
                </div>
            `;

            const customIcon = L.divIcon({
                html: iconHtml, className: cssClass, iconSize: [size, size], iconAnchor: [size/2, size/2]
            });

            const marker = L.marker([est.coords.lat, est.coords.lon], {icon: customIcon});
            
            // Adiciona evento de clique passando a LISTA JÁ FILTRADA
            marker.on('click', () => {
                CarregarSidebar(listaFiltrada);
                map.flyTo([est.coords.lat, est.coords.lon], 6, {duration: 1.2});
            });

            markersLayer.addLayer(marker);
        });
    }

    function CarregarSidebar(listaCtcs) {
        const container = document.getElementById('lista-ctcs');
        container.innerHTML = '';

        if(listaCtcs.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhum registro encontrado.</div>';
            return;
        }

        // Ordenação: Urgente primeiro, depois maior frete
        const listaOrdenada = listaCtcs.sort((a, b) => {
            if (a.eh_urgente && !b.eh_urgente) return -1;
            if (!a.eh_urgente && b.eh_urgente) return 1;
            return parseFloat(b.raw_frete_total || 0) - parseFloat(a.raw_frete_total || 0);
        });

        listaOrdenada.forEach(c => {
            const isUrg = c.eh_urgente;
            const classeCard = isUrg ? 'urgente' : 'normal';
            const badgeHtml = isUrg ? `<span class="badge-urg"><i class="bi bi-exclamation-triangle"></i> URGENTE</span>` : ``;
            
            let urlFinal = URL_BASE_MONTAR
                .replace('__FIL__', c.filial)
                .replace('__SER__', c.serie)
                .replace('__NUM__', c.ctc);
            
            const jsonFullData = encodeURIComponent(JSON.stringify(c.full_data));

            const html = `
                <div class="ctc-card ${classeCard}">
                    <div class="card-header-flex">
                        <span class="badge-serie">${c.filial}-${c.serie}-${c.ctc}</span>
                        ${badgeHtml}
                    </div>
                    
                    <div class="rota-display">
                        ${c.origem.split('/')[0]} 
                        <i class="bi bi-arrow-right seta-display"></i> 
                        ${c.destino.split('/')[0]}
                    </div>
                    
                    <div class="cliente-display" title="${c.remetente}">
                        <i class="bi bi-person-circle"></i> ${c.remetente}
                    </div>

                    <div class="data-emissao" style="font-size:0.7rem; color:#888; margin-bottom:8px;">
                        <i class="bi bi-calendar-event"></i> ${c.data_emissao}
                        <span style="float:right; font-weight:bold; color:#666;">${c.origem_dados}</span>
                    </div>

                    <div class="card-stats">
                        <div class="stat-box">
                            <span class="stat-label">Peso (Fís / Tax)</span>
                            <span class="stat-val">
                                ${c.peso_fisico} / <strong>${c.peso_taxado}</strong>
                            </span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Volumes</span>
                            <span class="stat-val">${c.volumes}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">NFs</span>
                            <span class="stat-val">${c.qtd_notas}</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Mercadoria</span>
                            <span class="stat-val stat-money">${fmtShortMoney(c.raw_val_mercadoria)}</span>
                        </div>
                    </div>

                    <div class="card-actions">
                        <a href="${urlFinal}" class="btn-planejar">
                            <i class="bi bi-airplane"></i> Planejar Voo
                        </a>
                        <button class="btn-detalhes" onclick="AbrirModalGlobal('${c.filial}', '${c.serie}', '${c.ctc}')" 
                        title="Ver Documento Completo">
                            <i class="ph-bold ph-file-text"></i>
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // --- LÓGICA DO MODAL ---
    function AbrirModal(ctcNum, jsonDataEncoded) {
        const modal = document.getElementById('modal-detalhes');
        const titulo = document.getElementById('modal-ctc-id');
        const tabela = document.getElementById('tabela-detalhes');
        const data = JSON.parse(decodeURIComponent(jsonDataEncoded));
        
        titulo.innerText = ctcNum;
        tabela.innerHTML = ''; 

        for (const [key, value] of Object.entries(data)) {
            if(value !== null && value !== "") {
                const row = `
                    <tr>
                        <th>${key}</th>
                        <td>${value}</td>
                    </tr>
                `;
                tabela.innerHTML += row;
            }
        }
        modal.style.display = 'flex';
    }

    function FecharModal(event) {
        if(!event || event.target.className === 'modal-overlay' || event.target.className === 'btn-close') {
            document.getElementById('modal-detalhes').style.display = 'none';
        }
    }
</script>
{% endblock %}