{% extends "Base.html" %}

{% block titulo %}Monitoramento A√©reo | FlightOps{% endblock %}

{% block conteudo %}

<style>
    /* --- TEMA EXECUTIVO --- */
    .dash-executivo {
        --cor-destaque: #0d6efd;       /* Azul Principal */
        --cor-sucesso: #198754;        /* Verde Status */
        --cor-texto: #212529;
        --cor-texto-suave: #6c757d;
        --cor-borda: #e0e0e0;
        --bg-fundo: #f8f9fa;
        
        font-family: 'Inter', -apple-system, sans-serif;
        color: var(--cor-texto);
        height: calc(100vh - 80px); /* Ocupa altura total menos topo */
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 10px 20px 20px 20px;
        box-sizing: border-box;
    }

    /* --- CABE√áALHO --- */
    .dash-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--cor-borda);
    }

    .header-left h2 {
        margin: 0; font-size: 1.6rem; font-weight: 700; color: #1a1a1a;
        display: flex; align-items: center; gap: 12px;
    }
    .header-sub { font-size: 0.85rem; color: var(--cor-texto-suave); margin-top: 4px; }

    /* Bot√£o Torre de Controle */
    .btn-torre {
        text-decoration: none;
        background: #212529; color: #fff;
        padding: 10px 18px; border-radius: 6px;
        font-weight: 600; font-size: 0.9rem;
        display: flex; align-items: center; gap: 8px;
        transition: transform 0.2s, background 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-torre:hover { background: #000; transform: translateY(-2px); }

    /* Tag Ao Vivo */
    .live-badge {
        font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
        color: var(--cor-sucesso); background: rgba(25, 135, 84, 0.1);
        padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(25, 135, 84, 0.2);
        display: flex; align-items: center; gap: 6px;
    }
    .live-dot {
        width: 8px; height: 8px; background-color: var(--cor-sucesso);
        border-radius: 50%; animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* --- KPIS (INDICADORES) --- */
    .kpi-container {
        display: flex; gap: 20px;
    }
    .kpi-card {
        background: #fff; border: 1px solid var(--cor-borda);
        border-radius: 8px; padding: 10px 20px;
        min-width: 150px; display: flex; flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .kpi-titulo { font-size: 0.75rem; color: var(--cor-texto-suave); font-weight: 600; text-transform: uppercase; }
    .kpi-valor { font-size: 1.3rem; font-weight: 700; color: var(--cor-texto); margin-top: 2px; }
    .kpi-destaque { color: var(--cor-sucesso); }

    /* --- TABELA --- */
    .table-wrapper {
        background: #fff; border: 1px solid var(--cor-borda);
        border-radius: 8px; flex: 1; overflow: hidden;
        display: flex; flex-direction: column;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    
    .table-scroll { flex: 1; overflow: auto; }

    .dash-table {
        width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap;
    }
    .dash-table th {
        position: sticky; top: 0; z-index: 10;
        background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 0.7rem;
        padding: 14px 12px; border-bottom: 2px solid #eee; text-align: left;
    }
    .dash-table td {
        padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; color: #444;
    }
    .dash-table tr:hover td { background-color: #f8f9fa; }

    /* Colunas Especiais */
    .col-filial { font-weight: bold; color: #333; text-align: center; }
    .col-ctc { font-weight: 700; color: var(--cor-destaque); font-family: monospace; font-size: 0.9rem; }
    .col-rota { font-weight: 600; }
    .col-money { font-family: 'Consolas', monospace; text-align: right; font-weight: 600; }
    .col-prio span { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
    
    /* Status Badges */
    .bg-alta { background: #fee2e2; color: #dc2626; }
    .bg-normal { background: #e9ecef; color: #495057; }

    /* Bot√£o de A√ß√£o da Tabela */
    .btn-table-action {
        background: #fff; border: 1px solid #ddd;
        width: 32px; height: 32px; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
        text-decoration: none; transition: 0.2s; cursor: pointer;
    }
    .btn-table-action:hover { background: #0d6efd; color: #fff; border-color: #0d6efd; transform: scale(1.1); }

    /* Anima√ß√£o */
    .novo-item { animation: highlight 1s ease-out; }
    @keyframes highlight { from { background-color: #e8f5e9; } to { background-color: transparent; } }

</style>

<div class="dash-executivo">

    <div class="dash-header">
        <div class="header-left">
            <h2>
                Emiss√µes A√©reo
                <div class="live-badge"><div class="live-dot"></div> On Time</div>
            </h2>
            <div class="header-sub">
                Monitoramento em tempo real ‚Ä¢ <span id="data-extenso"></span>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card">
                <span class="kpi-titulo">Volume Doc.</span>
                <span class="kpi-valor" id="kpi-docs">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-titulo">Peso Taxado</span>
                <span class="kpi-valor" id="kpi-peso">0 kg</span>
            </div>
            <div class="kpi-card" style="border-bottom: 3px solid var(--cor-sucesso);">
                <span class="kpi-titulo" style="color: var(--cor-sucesso);">Faturamento</span>
                <span class="kpi-valor kpi-destaque" id="kpi-fat">R$ 0,00</span>
            </div>
            
            <a href="{{ url_for('Planejamento.MapaGlobal') }}" class="btn-torre">
                üåç Torre de Controle
            </a>
        </div>
    </div>

    <div class="table-wrapper">
        <div class="table-scroll">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th width="50" style="text-align:center;">A√ß√£o</th>
                        <th class="col-filial" width="60">Filial</th>
                        <th width="100">Documento</th>
                        <th width="80">Hora</th>
                        <th width="80">Data</th>
                        <th width="90" style="text-align:center;">Prioridade</th>
                        <th>Rota (Origem ‚ûù Destino)</th>
                        <th>Remetente</th>
                        <th>Destinat√°rio</th>
                        <th style="text-align:right;">Vol.</th>
                        <th style="text-align:right;">Peso Tax.</th>
                        <th style="text-align:right;">Peso</th>
                        <th style="text-align:right;">Valor Merc.</th>
                        <th width="100" style="text-align:center;">NFs</th>
                        <th style="text-align:right;">Frete Total</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr><td colspan="12" style="text-align:center; padding:40px; color:#999;">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- L√ìGICA DO DASHBOARD ---
    
    // Rotas do Flask injetadas no JS
    const URLS = {
        api: "{{ url_for('Planejamento.ApiCtcsHoje') }}",
        baseMontar: "{{ url_for('Planejamento.MontarPlanejamento', filial='0', serie='0', ctc='0') }}"
    };

    function gerarLink(filial, serie, ctc) {
        return URLS.baseMontar
            .replace('/0/0/0', `/${filial}/${serie}/${ctc}`) // com barra
            .replace('0/0/0', `${filial}/${serie}/${ctc}`);  // sem barra
    }

    // Data Atual
    const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    document.getElementById('data-extenso').innerText = new Date().toLocaleDateString('pt-BR', opts);

    let vistos = new Set();

    async function Atualizar() {
        try {
            const resp = await fetch(URLS.api);
            const dados = await resp.json();
            const tbody = document.getElementById('table-body');

            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:40px; color:#999;">Sem emiss√µes a√©reas hoje.</td></tr>';
                AtualizarKPIs(0, 0, 0);
                return;
            }

            let somaFat = 0;
            let somaPeso = 0;

            const html = dados.map(r => {
                somaFat += r.raw_frete_total;
                somaPeso += r.peso_taxado;

                // Anima√ß√£o para novos itens
                const novo = !vistos.has(r.id_unico);
                if (novo) vistos.add(r.id_unico);
                const classeAnim = novo ? 'novo-item' : '';

                // Badge de Prioridade
                const pCls = r.prioridade === 'URGENTE' ? 'bg-alta' : 'bg-normal';
                
                return `
                <tr class="${classeAnim}">
                    <td style="text-align:center;">
                        <a href="${gerarLink(r.filial, r.serie, r.ctc)}" class="btn-table-action" title="Planejar Rota">
                            üó∫Ô∏è
                        </a>
                    </td>
                    <td class="col-filial">${r.filial}</td>
                    <td class="col-ctc">${r.ctc}</td>
                    <td style="color:#666;">${r.data_emissao}</td>
                    <td style="color:#666;">${r.hora_emissao}</td>
                    <td style="text-align:center;" class="col-prio">
                        <span class="${pCls}">${r.prioridade || 'NORMAL'}</span>
                    </td>
                    <td class="col-rota">
                        ${r.origem} <span style="color:#ccc;">‚ûù</span> ${r.destino}
                    </td>
                    <td title="${r.remetente}">${r.remetente.substring(0,15)}...</td>
                    <td title="${r.destinatario}">${r.destinatario.substring(0,15)}...</td>
                    
                    <td style="text-align:right;">${r.volumes}</td>
                    <td style="text-align:right;">${r.peso_taxado.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td style="text-align:right; color:#666;">${r.peso_real.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td class="col-money" style="font-size:0.8rem; color:#666;">${r.val_mercadoria}</td>
                    <td style="text-align:center;">${r.nfs}</td>
                    <td class="col-money" style="color:var(--cor-sucesso); background:#fcfcfc;">${r.frete_total}</td>

                </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
            AtualizarKPIs(dados.length, somaPeso, somaFat);

        } catch (e) {
            console.error("Erro refresh:", e);
        }
    }

    function AtualizarKPIs(docs, peso, valor) {
        document.getElementById('kpi-docs').innerText = docs;
        document.getElementById('kpi-peso').innerText = peso.toLocaleString('pt-BR', {maximumFractionDigits:0}) + ' kg';
        document.getElementById('kpi-fat').innerText = valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

    // Loop
    Atualizar();
    setInterval(Atualizar, 10000);

</script>
{% endblock %}