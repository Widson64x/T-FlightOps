{% extends "Base.html" %}

{% block titulo %}Cockpit de Planejamento | Luft-ConnectAir{% endblock %}

{% block conteudo %}
{% include "Components/_ModalCtc.html" %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-rotatedmarker/0.2.0/leaflet.rotatedMarker.min.js"></script> 
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Planejamento/Editor.css') }}">

<div class="map-wrapper">
    <div id="map"></div>

    <div class="glass-sidebar">
        
        <div class="sidebar-header-editor">
            <div class="header-top">
                <div class="badge-serie {{ 'is-lote' if Ctc.is_consolidado else '' }}" 
                     onclick="{% if Ctc.is_consolidado %}AbrirModalLote(){% endif %}"
                     style="{{ 'cursor: pointer;' if Ctc.is_consolidado else '' }}"
                     title="{{ 'Clique para ver os documentos' if Ctc.is_consolidado else '' }}">
                    
                    {% if Ctc.is_consolidado %}
                        <i class="ph-bold ph-stack"></i> Lote: {{ Ctc.qtd_docs }} docs <i class="ph-bold ph-caret-down" style="margin-left: 5px; font-size: 0.8em;"></i>
                    {% else %}
                        <i class="ph-bold ph-file-text"></i> CTC Individual
                    {% endif %}
                </div>

                <div class="badge-prioridade {{ 'urgente' if 'URGENTE' in (Ctc.prioridade|upper) else 'normal' }}">
                    {{ Ctc.prioridade or 'Normal' }}
                </div>
            </div>

            <h2 class="route-title">
                {{ Ctc.origem_cidade }} <i class="ph-bold ph-airplane-tilt"></i> {{ Ctc.destino_cidade }}
            </h2>
            <div class="route-subtitle">
                <span>{{ Ctc.filial }}-{{ Ctc.serie }}-{{ Ctc.ctc }}</span> • 
                <span>Fís: {{ Ctc.peso_fisico|float|round(2) }} | Tax: <strong>{{ Ctc.peso_taxado|float|round(2) }} kg</strong></span> • 
                <span>R$ {{ "{:,.2f}".format(Ctc.valor) }}</span>
            </div>
        </div>

        <div class="strategy-tabs">     
            <button class="tab-btn active" onclick="SelecionarEstrategia('recomendada')" id="tab-recomendada" title="Melhor Custo-Benefício">
                <i class="ph-duotone ph-star"></i> <span>Recomendada</span>
            </button>
            
            <button class="tab-btn" onclick="SelecionarEstrategia('direta')" id="tab-direta" title="Voo Direto (Sem Escalas)">
                <i class="ph-duotone ph-paper-plane-right"></i> <span>Direta</span>
            </button>
            
            <button class="tab-btn" onclick="SelecionarEstrategia('rapida')" id="tab-rapida" title="Menor Tempo Total">
                <i class="ph-duotone ph-lightning"></i> <span>Rápida</span>
            </button>
            
            <button class="tab-btn" onclick="SelecionarEstrategia('economica')" id="tab-economica" title="Menor Custo de Frete">
                <i class="ph-duotone ph-coins"></i> <span>Econômica</span>
            </button>
            
            <button class="tab-btn" onclick="SelecionarEstrategia('conexao_mesma_cia')" id="tab-conexao_mesma_cia" title="Conexão Mesma Cia">
                <i class="ph-duotone ph-airplane-tilt"></i> <span>Conexão</span>
            </button>
            
            <button class="tab-btn" onclick="SelecionarEstrategia('interline')" id="tab-interline" title="Múltiplas Cias Aéreas">
                <i class="ph-duotone ph-shuffle"></i> <span>Interline</span>
            </button>
        </div>

        <div class="strategy-summary" id="strategy-metrics">
            <div class="metric-item"><span class="lbl">Custo Est.</span><span class="val">--</span></div>
            <div class="metric-item"><span class="lbl">Tempo Total</span><span class="val">--</span></div>
            <div class="metric-item"><span class="lbl">Conexões</span><span class="val">--</span></div>
        </div>

        <div class="timeline-container" id="timeline-content">
            <div class="loading-state" style="text-align:center; padding: 40px; color: var(--cor-texto-secundario);">
                <i class="ph-bold ph-spinner ph-spin" style="font-size: 2rem;"></i> 
                <p>Calculando melhores rotas...</p>
            </div>
        </div>

        <div class="sidebar-editor-footer">
            <a href="{{ url_for('Planejamento.Dashboard') }}" class="btn-cancel">Cancelar</a>
            <button class="btn-confirm" onclick="ConfirmarPlanejamento()" id="btn-confirmar">
                <i class="ph-bold ph-check-circle"></i> Confirmar Rota
            </button>
        </div>
    </div>
</div>

{% if Ctc.is_consolidado %}
<div id="modal-lote-backdrop" class="modal-backdrop hidden" onclick="FecharModalLote(event)">
    <div class="glass-modal-large">
        <div class="modal-header">
            <h3><i class="ph-duotone ph-stack"></i> Composição do Lote</h3>
            <button class="btn-close" onclick="FecharModalLote(null)"><i class="ph-bold ph-x"></i></button>
        </div>
        
        <div class="modal-body-scroll">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th>Documento</th>
                        <th>Destinatário</th>
                        <th class="text-center">Vol</th>
                        <th class="text-right">Peso</th>
                        <th class="text-right">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in Ctc.lista_docs %}
                    <tr>
                        <td class="fw-bold">{{ doc.filial }}-{{ doc.serie }}-{{ doc.ctc }}</td>
                        <td>{{ doc.destinatario[:25] }}...</td>
                        <td class="text-center">{{ doc.volumes }}</td>
                        <td class="text-right">{{ doc.peso_fisico|float|round(2) }} kg</td>
                        <td class="text-right">R$ {{ "{:,.2f}".format(doc.valor) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-right fw-bold">TOTAL DO LOTE:</td>
                        <td class="text-center fw-bold">{{ Ctc.volumes }}</td>
                        <td class="text-right fw-bold">{{ Ctc.peso_fisico|float|round(2) }} kg</td>
                        <td class="text-right fw-bold">R$ {{ "{:,.2f}".format(Ctc.valor) }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Dados injetados pelo Backend
    window.opcoesRotas = {{ OpcoesRotas | tojson | safe }};
    window.ctc = {{ Ctc | tojson | safe }};
    window.origemCoords = { lat: {{ Origem.lat | default(0) }}, lon: {{ Origem.lon | default(0) }} };
    window.destinoCoords = { lat: {{ Destino.lat | default(0) }}, lon: {{ Destino.lon | default(0) }} };
    const URL_GRAVAR_PLANEJAMENTO = "{{ url_for('Planejamento.SalvarPlanejamento') }}";
</script>
<script src="{{ url_for('static', filename='JS/Planejamento/Editor.js') }}"></script>
{% endblock %}