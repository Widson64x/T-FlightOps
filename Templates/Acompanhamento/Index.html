{% extends "Base.html" %}

{% block titulo %}Painel de Acompanhamento | FlightOps{% endblock %}

{% block conteudo %}
{% include 'Components/_ModalAwb.html' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
    /* --- LAYOUT GLOBAL --- */
    .dashboard-container {
        display: flex; flex-direction: column; gap: 6px;
        height: 100vh; padding: 10px; overflow: hidden;
    }
    
    /* --- TOP BAR (FILTROS) --- */
    .filter-bar {
        flex: 0 0 auto; background: var(--cor-fundo-painel);
        border-radius: var(--radius-default); border: 1px solid var(--cor-borda);
        box-shadow: var(--sombra-suave); padding: 12px 20px;
        display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;
    }

    .filter-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 150px; }
    .filter-group.small { flex: 0 0 150px; }
    .filter-group.btn-area { flex: 0 0 auto; min-width: auto; }

    .input-label { font-size: 0.7rem; font-weight: 700; color: var(--cor-texto-secundario); text-transform: uppercase; letter-spacing: 0.5px; }
    .input-field {
        width: 100%; padding: 8px 12px; background: var(--cor-fundo-principal);
        border: 1px solid var(--cor-borda); border-radius: 8px; color: var(--cor-texto-principal);
        transition: 0.2s; font-size: 0.9rem;
    }
    .input-field:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 3px rgba(var(--cor-primaria-rgb), 0.1); }
    
    .btn-apply {
        background: var(--cor-primaria); color: #fff; border: none; padding: 8px 20px; height: 38px;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        display: flex; align-items: center; gap: 8px; white-space: nowrap;
    }
    .btn-apply:hover { background: var(--cor-primaria-hover); transform: translateY(-1px); }

    .kpi-resumo { margin-left: auto; padding-left: 20px; border-left: 1px solid var(--cor-borda); text-align: right; }

    /* --- MAPA GRANDE --- */
    .map-section {
        width: 100%; flex: 1; min-height: 300px; border-radius: var(--radius-default);
        overflow: hidden; border: 1px solid var(--cor-borda); box-shadow: var(--sombra-card);
        position: relative; background: #fff;
    }

    /* --- TABELA MENOR --- */
    .table-section {
        flex: 1; background: var(--cor-fundo-painel); border-radius: var(--radius-default);
        border: 1px solid var(--cor-borda); box-shadow: var(--sombra-card);
        display: flex; flex-direction: column; overflow: hidden; min-height: 0;
    }

    .table-header { padding: 12px 24px; border-bottom: 1px solid var(--cor-borda); display: flex; justify-content: space-between; align-items: center; flex: 0 0 auto; }
    .table-title { font-weight: 700; font-size: 1rem; color: var(--cor-texto-principal); display: flex; align-items: center; gap: 10px; }
    
    .table-responsive { width: 100%; overflow-y: auto; flex: 1; }
    table { width: 100%; border-collapse: collapse; }
    th {
        text-align: left; padding: 12px 24px; font-size: 0.75rem; font-weight: 600;
        text-transform: uppercase; color: var(--cor-texto-secundario); background: #f8fafc;
        position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--cor-borda);
    }
    td { padding: 12px 24px; border-bottom: 1px solid var(--cor-borda); font-size: 0.85rem; color: var(--cor-texto-principal); vertical-align: middle; }
    
    .row-main { cursor: pointer; transition: 0.2s; background: #fff; }
    .row-main:hover { background-color: #f1f5f9; }
    .row-main.active { background-color: #eff6ff; border-left: 4px solid var(--cor-primaria); }

    .detail-cell { background: #f8fafc; padding: 0 !important; border-bottom: 1px solid var(--cor-borda); }
    .timeline-container { padding: 20px 40px; }
    
    /* INTERAÇÃO DUPLO CLIQUE */
    .voo-interativo {
        cursor: pointer; border-bottom: 1px dashed var(--cor-primaria); 
        transition: 0.2s; color: var(--cor-texto-principal);
    }
    .voo-interativo:hover { background-color: rgba(var(--cor-primaria-rgb), 0.1); color: var(--cor-primaria); }

    /* --- LEGENDAS E MAPA --- */
    .map-controls-container { position: absolute; top: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .btn-map-info {
        width: 36px; height: 36px; background: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        font-size: 1.2rem; color: var(--cor-primaria); transition: 0.2s; border: 1px solid var(--cor-borda);
    }
    .btn-map-info:hover { background: var(--cor-primaria); color: #fff; transform: scale(1.05); }

    .map-legend-panel {
        position: absolute; top: 0; left: 45px; width: 240px; background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(8px); border-radius: 12px; padding: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid var(--cor-borda);
        opacity: 0; visibility: hidden; transform: translateX(-10px); transition: all 0.3s ease; pointer-events: none;
    }
    .map-controls-container:hover .map-legend-panel { opacity: 1; visibility: visible; transform: translateX(0); pointer-events: auto; }

    .lg-section { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .lg-section:last-child { margin-bottom: 0; border: none; padding-bottom: 0; }
    .lg-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px; }
    .lg-item { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #334155; margin-bottom: 6px; font-weight: 500; }
    .lg-icon { width: 16px; display: flex; justify-content: center; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: block; }
    .line { width: 16px; height: 3px; border-radius: 2px; display: block; }

    /* --- MODAL DETALHES VOO (IGUAL MAPA DE ESCALAS) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-card {
        background: var(--cor-fundo-painel); width: 400px;
        border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        overflow: hidden; animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .m-header { padding: 20px 24px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .mh-latam { background: linear-gradient(135deg, #E30613, #b3000b); }
    .mh-gol { background: linear-gradient(135deg, #FF7020, #e05e15); }
    .mh-azul { background: linear-gradient(135deg, #009FE3, #0077aa); }
    .mh-default { background: #495057; }

    .m-body { padding: 24px; }
    .m-route { 
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px;
    }
    .m-iata { font-size: 1.8rem; font-weight: 800; color: var(--cor-texto-principal); }
    
    .m-info-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--cor-borda); padding-bottom: 8px; }
    .m-lbl { font-size: 0.75rem; color: var(--cor-texto-secundario); font-weight: 600; text-transform: uppercase; }
    .m-val { font-weight: 700; color: var(--cor-texto-principal); font-size: 0.95rem; }

    .m-close-btn { 
        background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; 
        opacity: 0.8; transition: 0.2s;
    }
    .m-close-btn:hover { opacity: 1; transform: scale(1.1); }

</style>

<div class="dashboard-container">
    
    <div class="filter-bar">
        <div class="filter-group">
            <label class="input-label">Buscar AWB</label>
            <div style="position: relative;">
                <i class="ph-bold ph-magnifying-glass" style="position: absolute; top: 11px; left: 10px; color: #94a3b8;"></i>
                <input type="text" id="buscaAwb" class="input-field" placeholder="Ex: 957-..." style="padding-left: 32px;">
            </div>
        </div>

        <div class="filter-group">
            <label class="input-label">Filial CTC</label>
            <div style="position: relative;">
                <i class="ph-bold ph-file-text" style="position: absolute; top: 11px; left: 10px; color: #94a3b8;"></i>
                <input type="text" id="buscaFilialCtc" class="input-field" placeholder="N° Filial CTC..." style="padding-left: 32px;">
            </div>
        </div>
        <div class="filter-group small">
            <label class="input-label">De</label>
            <input type="date" id="dataInicio" class="input-field" value="{{ data_inicio }}">
        </div>
        <div class="filter-group small">
            <label class="input-label">Até</label>
            <input type="date" id="dataFim" class="input-field" value="{{ data_fim }}">
        </div>
        <div class="filter-group btn-area">
            <button class="btn-apply" onclick="CarregarDados()">Filtrar <i class="ph-bold ph-caret-right"></i></button>
        </div>
        <div class="kpi-resumo">
            <div style="font-size: 0.7rem; text-transform: uppercase; color: var(--cor-texto-secundario); font-weight: 700;">Listadas</div>
            <div style="font-size: 1.8rem; font-weight: 800; color: var(--cor-primaria); line-height: 1;" id="lbl-total">0</div>
        </div>
    </div>

    <div class="map-section">
        <div id="mapa-voos" style="width: 100%; height: 100%; z-index: 1;"></div>
        
        <div class="map-controls-container">
            <div class="btn-map-info">
                <i class="ph-bold ph-info"></i>
            </div>

            <div class="map-legend-panel">
                <div class="lg-section">
                    <div class="lg-title">Status da Localização</div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #10b981; border: 2px solid #fff; box-shadow: 0 0 0 1px #10b981;"></span></div>
                        <span>Origem (Embarque)</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #ef4444; border: 2px solid #fff; box-shadow: 0 0 0 1px #ef4444;"></span></div>
                        <span>Local Atual (Carga)</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #94a3b8; border: 2px dashed #fff;"></span></div>
                        <span>Destino Final</span>
                    </div>
                </div>

                <div class="lg-section">
                    <div class="lg-title">Linhas de Rota</div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #e30613;"></span></div>
                        <span>Voo LATAM</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #ff7020;"></span></div>
                        <span>Voo GOL</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #0d6efd;"></span></div>
                        <span>Voo AZUL</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #94a3b8; border-bottom: 2px dashed #94a3b8; height: 0;"></span></div>
                        <span>Rota Pendente</span>
                    </div>
                </div>
                
                <div class="lg-section">
                    <div class="lg-title">Ícones Especiais</div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #10b981;"></i></div>
                        <span>Chegou ao Destino</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #f59e0b;"></i></div>
                        <span>Em Trânsito Aéreo</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #ef4444;"></i></div>
                        <span>Aguardando Decolagem</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-section">
        <div class="table-header">
            <span class="table-title"><i class="ph-duotone ph-airplane-in-flight"></i> Detalhamento das Cargas</span>
        </div>
        <div class="table-responsive">
            <table id="tabela-awbs">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>AWB</th>
                        <th>Cia</th>
                        <th>Rota</th>
                        <th>Voo Atual</th>
                        <th>Peso (Kg)</th>
                        <th>Status</th>
                        <th>Data Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-voo">
    <div class="modal-card">
        <div class="m-header mh-default" id="mv-header">
            <div style="display: flex; gap: 10px; align-items: center;">
                <i class="ph-fill ph-airplane-tilt" style="font-size: 1.5rem;"></i>
                <div style="display: flex; flex-direction: column;">
                    <span id="mv-cia" style="font-size: 0.8rem; opacity: 0.9;">CIA</span>
                    <span id="mv-numero" style="font-size: 1.4rem; font-weight: 800; line-height: 1;">VOO 0000</span>
                </div>
            </div>
            <button class="m-close-btn" onclick="FecharModalVoo()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="m-body">
            <div class="m-route">
                <div style="text-align: center;">
                    <div class="m-iata" id="mv-origem">GRU</div>
                    <div style="font-size: 0.7rem; color: #666; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="mv-origem-nome">-</div>
                </div>
                <i class="ph-bold ph-airplane-takeoff" style="font-size: 1.5rem; color: var(--cor-primaria);"></i>
                <div style="text-align: center;">
                    <div class="m-iata" id="mv-destino">MIA</div>
                    <div style="font-size: 0.7rem; color: #666; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="mv-destino-nome">-</div>
                </div>
            </div>

            <div class="m-info-row">
                <span class="m-lbl">Data da Partida</span>
                <span class="m-val" id="mv-data">00/00/0000</span>
            </div>
            <div class="m-info-row">
                <span class="m-lbl">Horário Saída</span>
                <span class="m-val" id="mv-saida">00:00</span>
            </div>
            <div class="m-info-row">
                <span class="m-lbl">Horário Chegada</span>
                <span class="m-val" id="mv-chegada">00:00</span>
            </div>
             <div class="m-info-row" style="border:none;">
            </div>
        </div>
    </div>
</div>

<script>
    // Objeto de Configuração para injetar as URLs do Jinja2 no JS externo
    const APP_CONFIG = {
        urls: {
            listarAwbs: "{{ url_for('Acompanhamento.ApiListarAwbs') }}",
            // Passa a URL base sem o número, o JS concatena o ID depois
            historico: "{{ url_for('Acompanhamento.ApiHistorico', numero_awb='') }}", 
            detalhesVoo: "{{ url_for('Acompanhamento.ApiDetalhesVooModal') }}"
        }
    };
</script>

<script src="{{ url_for('static', filename='JS/Acompanhamento/Index.js') }}"></script>

{% endblock %}