{% extends "Base.html" %}

{% block titulo %}Painel de Acompanhamento | FlightOps{% endblock %}

{% block conteudo %}
{% include 'Components/_ModalAwb.html' %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
    /* --- LAYOUT GLOBAL --- */
    .dashboard-container {
        display: flex; flex-direction: column; gap: 6px;
        height: 100vh; padding: 10px; overflow: hidden;
    }
    
    /* --- TOP BAR (FILTROS) --- */
    .filter-bar {
        flex: 0 0 auto; background: var(--cor-fundo-painel);
        border-radius: var(--radius-default); border: 1px solid var(--cor-borda);
        box-shadow: var(--sombra-suave); padding: 12px 20px;
        display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;
    }

    .filter-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 150px; }
    .filter-group.small { flex: 0 0 150px; }
    .filter-group.btn-area { flex: 0 0 auto; min-width: auto; }

    .input-label { font-size: 0.7rem; font-weight: 700; color: var(--cor-texto-secundario); text-transform: uppercase; letter-spacing: 0.5px; }
    .input-field {
        width: 100%; padding: 8px 12px; background: var(--cor-fundo-principal);
        border: 1px solid var(--cor-borda); border-radius: 8px; color: var(--cor-texto-principal);
        transition: 0.2s; font-size: 0.9rem;
    }
    .input-field:focus { border-color: var(--cor-primaria); box-shadow: 0 0 0 3px rgba(var(--cor-primaria-rgb), 0.1); }
    
    .btn-apply {
        background: var(--cor-primaria); color: #fff; border: none; padding: 8px 20px; height: 38px;
        border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        display: flex; align-items: center; gap: 8px; white-space: nowrap;
    }
    .btn-apply:hover { background: var(--cor-primaria-hover); transform: translateY(-1px); }

    .kpi-resumo { margin-left: auto; padding-left: 20px; border-left: 1px solid var(--cor-borda); text-align: right; }

    /* --- MAPA GRANDE --- */
    .map-section {
        width: 100%; flex: 1; min-height: 300px; border-radius: var(--radius-default);
        overflow: hidden; border: 1px solid var(--cor-borda); box-shadow: var(--sombra-card);
        position: relative; background: #fff;
    }

    /* --- TABELA MENOR --- */
    .table-section {
        flex: 1; background: var(--cor-fundo-painel); border-radius: var(--radius-default);
        border: 1px solid var(--cor-borda); box-shadow: var(--sombra-card);
        display: flex; flex-direction: column; overflow: hidden; min-height: 0;
    }

    .table-header { padding: 12px 24px; border-bottom: 1px solid var(--cor-borda); display: flex; justify-content: space-between; align-items: center; flex: 0 0 auto; }
    .table-title { font-weight: 700; font-size: 1rem; color: var(--cor-texto-principal); display: flex; align-items: center; gap: 10px; }
    
    .table-responsive { width: 100%; overflow-y: auto; flex: 1; }
    table { width: 100%; border-collapse: collapse; }
    th {
        text-align: left; padding: 12px 24px; font-size: 0.75rem; font-weight: 600;
        text-transform: uppercase; color: var(--cor-texto-secundario); background: #f8fafc;
        position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--cor-borda);
    }
    td { padding: 12px 24px; border-bottom: 1px solid var(--cor-borda); font-size: 0.85rem; color: var(--cor-texto-principal); vertical-align: middle; }
    
    .row-main { cursor: pointer; transition: 0.2s; background: #fff; }
    .row-main:hover { background-color: #f1f5f9; }
    .row-main.active { background-color: #eff6ff; border-left: 4px solid var(--cor-primaria); }

    .detail-cell { background: #f8fafc; padding: 0 !important; border-bottom: 1px solid var(--cor-borda); }
    .timeline-container { padding: 20px 40px; }
    
    /* INTERAÇÃO DUPLO CLIQUE */
    .voo-interativo {
        cursor: pointer; border-bottom: 1px dashed var(--cor-primaria); 
        transition: 0.2s; color: var(--cor-texto-principal);
    }
    .voo-interativo:hover { background-color: rgba(var(--cor-primaria-rgb), 0.1); color: var(--cor-primaria); }

    /* --- LEGENDAS E MAPA --- */
    .map-controls-container { position: absolute; top: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .btn-map-info {
        width: 36px; height: 36px; background: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        font-size: 1.2rem; color: var(--cor-primaria); transition: 0.2s; border: 1px solid var(--cor-borda);
    }
    .btn-map-info:hover { background: var(--cor-primaria); color: #fff; transform: scale(1.05); }

    .map-legend-panel {
        position: absolute; top: 0; left: 45px; width: 240px; background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(8px); border-radius: 12px; padding: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid var(--cor-borda);
        opacity: 0; visibility: hidden; transform: translateX(-10px); transition: all 0.3s ease; pointer-events: none;
    }
    .map-controls-container:hover .map-legend-panel { opacity: 1; visibility: visible; transform: translateX(0); pointer-events: auto; }

    .lg-section { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .lg-section:last-child { margin-bottom: 0; border: none; padding-bottom: 0; }
    .lg-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.5px; }
    .lg-item { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #334155; margin-bottom: 6px; font-weight: 500; }
    .lg-icon { width: 16px; display: flex; justify-content: center; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: block; }
    .line { width: 16px; height: 3px; border-radius: 2px; display: block; }

    /* --- MODAL DETALHES VOO (IGUAL MAPA DE ESCALAS) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-card {
        background: var(--cor-fundo-painel); width: 400px;
        border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        overflow: hidden; animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .m-header { padding: 20px 24px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .mh-latam { background: linear-gradient(135deg, #E30613, #b3000b); }
    .mh-gol { background: linear-gradient(135deg, #FF7020, #e05e15); }
    .mh-azul { background: linear-gradient(135deg, #009FE3, #0077aa); }
    .mh-default { background: #495057; }

    .m-body { padding: 24px; }
    .m-route { 
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px;
    }
    .m-iata { font-size: 1.8rem; font-weight: 800; color: var(--cor-texto-principal); }
    
    .m-info-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--cor-borda); padding-bottom: 8px; }
    .m-lbl { font-size: 0.75rem; color: var(--cor-texto-secundario); font-weight: 600; text-transform: uppercase; }
    .m-val { font-weight: 700; color: var(--cor-texto-principal); font-size: 0.95rem; }

    .m-close-btn { 
        background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; 
        opacity: 0.8; transition: 0.2s;
    }
    .m-close-btn:hover { opacity: 1; transform: scale(1.1); }

</style>

<div class="dashboard-container">
    
    <div class="filter-bar">
        <div class="filter-group">
            <label class="input-label">Buscar AWB</label>
            <div style="position: relative;">
                <i class="ph-bold ph-magnifying-glass" style="position: absolute; top: 11px; left: 10px; color: #94a3b8;"></i>
                <input type="text" id="buscaAwb" class="input-field" placeholder="Ex: 957-..." style="padding-left: 32px;">
            </div>
        </div>

        <div class="filter-group">
            <label class="input-label">Filial CTC</label>
            <div style="position: relative;">
                <i class="ph-bold ph-file-text" style="position: absolute; top: 11px; left: 10px; color: #94a3b8;"></i>
                <input type="text" id="buscaFilialCtc" class="input-field" placeholder="N° Filial CTC..." style="padding-left: 32px;">
            </div>
        </div>
        <div class="filter-group small">
            <label class="input-label">De</label>
            <input type="date" id="dataInicio" class="input-field" value="{{ data_inicio }}">
        </div>
        <div class="filter-group small">
            <label class="input-label">Até</label>
            <input type="date" id="dataFim" class="input-field" value="{{ data_fim }}">
        </div>
        <div class="filter-group btn-area">
            <button class="btn-apply" onclick="CarregarDados()">Filtrar <i class="ph-bold ph-caret-right"></i></button>
        </div>
        <div class="kpi-resumo">
            <div style="font-size: 0.7rem; text-transform: uppercase; color: var(--cor-texto-secundario); font-weight: 700;">Listadas</div>
            <div style="font-size: 1.8rem; font-weight: 800; color: var(--cor-primaria); line-height: 1;" id="lbl-total">0</div>
        </div>
    </div>

    <div class="map-section">
        <div id="mapa-voos" style="width: 100%; height: 100%; z-index: 1;"></div>
        
        <div class="map-controls-container">
            <div class="btn-map-info">
                <i class="ph-bold ph-info"></i>
            </div>

            <div class="map-legend-panel">
                <div class="lg-section">
                    <div class="lg-title">Status da Localização</div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #10b981; border: 2px solid #fff; box-shadow: 0 0 0 1px #10b981;"></span></div>
                        <span>Origem (Embarque)</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #ef4444; border: 2px solid #fff; box-shadow: 0 0 0 1px #ef4444;"></span></div>
                        <span>Local Atual (Carga)</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="dot" style="background: #94a3b8; border: 2px dashed #fff;"></span></div>
                        <span>Destino Final</span>
                    </div>
                </div>

                <div class="lg-section">
                    <div class="lg-title">Linhas de Rota</div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #e30613;"></span></div>
                        <span>Voo LATAM</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #ff7020;"></span></div>
                        <span>Voo GOL</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #0d6efd;"></span></div>
                        <span>Voo AZUL</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><span class="line" style="background: #94a3b8; border-bottom: 2px dashed #94a3b8; height: 0;"></span></div>
                        <span>Rota Pendente</span>
                    </div>
                </div>
                
                <div class="lg-section">
                    <div class="lg-title">Ícones Especiais</div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #10b981;"></i></div>
                        <span>Chegou ao Destino</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #f59e0b;"></i></div>
                        <span>Em Trânsito Aéreo</span>
                    </div>
                    <div class="lg-item">
                        <div class="lg-icon"><i class="ph-fill ph-airplane-tilt" style="color: #ef4444;"></i></div>
                        <span>Aguardando Decolagem</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-section">
        <div class="table-header">
            <span class="table-title"><i class="ph-duotone ph-airplane-in-flight"></i> Detalhamento das Cargas</span>
        </div>
        <div class="table-responsive">
            <table id="tabela-awbs">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>AWB</th>
                        <th>Cia</th>
                        <th>Rota</th>
                        <th>Voo Atual</th>
                        <th>Peso (Kg)</th>
                        <th>Status</th>
                        <th>Data Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-voo">
    <div class="modal-card">
        <div class="m-header mh-default" id="mv-header">
            <div style="display: flex; gap: 10px; align-items: center;">
                <i class="ph-fill ph-airplane-tilt" style="font-size: 1.5rem;"></i>
                <div style="display: flex; flex-direction: column;">
                    <span id="mv-cia" style="font-size: 0.8rem; opacity: 0.9;">CIA</span>
                    <span id="mv-numero" style="font-size: 1.4rem; font-weight: 800; line-height: 1;">VOO 0000</span>
                </div>
            </div>
            <button class="m-close-btn" onclick="FecharModalVoo()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="m-body">
            <div class="m-route">
                <div style="text-align: center;">
                    <div class="m-iata" id="mv-origem">GRU</div>
                    <div style="font-size: 0.7rem; color: #666; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="mv-origem-nome">-</div>
                </div>
                <i class="ph-bold ph-airplane-takeoff" style="font-size: 1.5rem; color: var(--cor-primaria);"></i>
                <div style="text-align: center;">
                    <div class="m-iata" id="mv-destino">MIA</div>
                    <div style="font-size: 0.7rem; color: #666; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="mv-destino-nome">-</div>
                </div>
            </div>

            <div class="m-info-row">
                <span class="m-lbl">Data da Partida</span>
                <span class="m-val" id="mv-data">00/00/0000</span>
            </div>
            <div class="m-info-row">
                <span class="m-lbl">Horário Saída</span>
                <span class="m-val" id="mv-saida">00:00</span>
            </div>
            <div class="m-info-row">
                <span class="m-lbl">Horário Chegada</span>
                <span class="m-val" id="mv-chegada">00:00</span>
            </div>
             <div class="m-info-row" style="border:none;">
            </div>
        </div>
    </div>
</div>

<script>
    var map = null;
    var layerGeral = new L.LayerGroup(); 
    var layerFoco = new L.LayerGroup();  

    function GetCorPorCia(texto) {
        if(!texto) return '#64748b';
        const t = texto.toUpperCase().trim(); 
        if (t.includes('LATAM') || t.includes('TAM') || /^(LA|JJ)(\s|-|\d|$)/.test(t)) return '#e30613';
        if (t.includes('GOL') || /^(G3)(\s|-|\d|$)/.test(t)) return '#ff7020';
        if (t.includes('AZUL') || /^(AD)(\s|-|\d|$)/.test(t)) return '#0d6efd';
        return '#64748b';
    }

    document.addEventListener('DOMContentLoaded', () => { InitMap(); CarregarDados(); });

    function InitMap() {
        if(map) return;
        map = L.map('mapa-voos', { zoomControl: false }).setView([-14.2350, -51.9253], 4);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; FlightOps', maxZoom: 18 }).addTo(map);
        layerGeral.addTo(map);
        layerFoco.addTo(map);
    }

    function CarregarDados() {
        // 1. Captura os valores dos inputs
        const inicio = document.getElementById('dataInicio').value;
        const fim = document.getElementById('dataFim').value;
        const awbBusca = document.getElementById('buscaAwb').value;
        const filialCtcBusca = document.getElementById('buscaFilialCtc').value; // <--- Novo Campo

        const tbody = document.querySelector('#tabela-awbs tbody');

        // 2. Estado de Carregamento
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:60px; color:var(--cor-texto-secundario);"><i class="ph-spinner ph-spin" style="font-size:28px;"></i><br><span style="margin-top:10px; display:block">Buscando cargas...</span></td></tr>`;
        
        ResetarMapaVisual(); 

        // 3. Montagem da URL com parâmetros dinâmicos
        let url = `{{ url_for('Acompanhamento.ApiListarAwbs') }}?dataInicio=${inicio}&dataFim=${fim}`;
        
        if(awbBusca) url += `&numeroAwb=${encodeURIComponent(awbBusca)}`;
        if(filialCtcBusca) url += `&filialCtc=${encodeURIComponent(filialCtcBusca)}`; // <--- Envia para a API

        // 4. Requisição
        fetch(url)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                document.getElementById('lbl-total').innerText = data.length;

                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px;">Nenhum registro encontrado.</td></tr>`;
                    return;
                }

                data.forEach(awb => {
                    PlotarRotaResumo(awb);
                    const rowId = `row-${awb.CodigoId}`;
                    const corCia = GetCorPorCia(awb.CiaAerea);

                    // Lógica de Status (Cores das Badges)
                    let badgeClass = 'badge-secondary';
                    const status = awb.Status ? awb.Status.toUpperCase() : '';

                    const successStatus = ['ENTREGUE', 'CARGA ENTREGUE'];
                    const dangerStatus = ['RETIDA', 'ATRASADO', 'DELAY', 'CANCELADO'];
                    const warningStatus = ['RECEPCAO DOCUMENTAL', 'LIBERADO PELA FISCALIZAÇÃO', 'EM PROCESSO DE LIBERAÇÃO FISCAL'];
                    const infoStatus = ['CARGA ALOCADA', 'EMBARQUE CONFIRMADO', 'AGUARDANDO DESEMBARQUE', 'AGUARDANDO', 'CARGA DESEMBARCADA', 'EMBARQUE SURFACE', 'DESEMBARQUE VÔO', 'EMBARQUE VÔO'];

                    if (successStatus.some(s => status.includes(s))) badgeClass = 'badge-success';
                    else if (dangerStatus.some(s => status.includes(s))) badgeClass = 'badge-danger';
                    else if (warningStatus.some(s => status.includes(s))) badgeClass = 'badge-warning';
                    else if (infoStatus.some(s => status.includes(s))) badgeClass = 'badge-info';

                    // Coluna Voo Interativo (Abre Modal Voo)
                    let htmlVoo = '<span style="color:#ccc;">-</span>';
                    if(awb.Voo && awb.Voo.length > 2) {
                        htmlVoo = `<span class="voo-interativo" title="Duplo clique para detalhes do voo" 
                                   ondblclick="AbrirModalVoo('${awb.Voo}', '${awb.DataStatus}', event)">
                                   <i class="ph-bold ph-airplane-tilt"></i> ${awb.Voo}</span>`;
                    }

                    // Criação da Linha Principal
                    let trMain = document.createElement('tr');
                    trMain.className = 'row-main';
                    trMain.id = rowId;
                    // Ao clicar na linha, expande o detalhe (árvore), exceto se clicar no voo ou na AWB (que tem eventos próprios)
                    trMain.onclick = (e) => { 
                        if(!e.target.closest('.voo-interativo') && !e.target.closest('td[ondblclick]')) {
                            ToggleTree(awb.Numero, rowId); 
                        }
                    };
                    
                    trMain.innerHTML = `
                        <td style="text-align:center;">
                            <i class="ph-bold ph-caret-right" id="icon-${rowId}" style="color:#64748b;"></i>
                        </td>

                        <td style="font-weight:700; color:var(--cor-primaria); font-family:monospace; cursor:pointer;"
                            title="Duplo clique para ver detalhes completos da Carga"
                            ondblclick="AbrirModalAwbDetalhes('${awb.CodigoId}', event)">
                            ${awb.Numero}
                        </td>

                        <td><span style="font-weight:600; color:${corCia};">${awb.CiaAerea || 'INDEF'}</span></td>
                        <td><span style="font-weight:700;">${awb.Origem}</span> <i class="ph-bold ph-arrow-right" style="font-size:0.8rem; color:#ccc;"></i> <span style="font-weight:700;">${awb.Destino}</span></td>
                        <td>${htmlVoo}</td>
                        <td>${awb.Peso.toFixed(1)} kg</td>
                        <td><span class="badge ${badgeClass}">${awb.Status}</span></td>
                        <td style="color:var(--cor-texto-secundario); font-size:0.8rem;">${awb.DataStatus}</td>
                    `;

                    // Criação da Linha de Detalhe (Expandable)
                    let trDetail = document.createElement('tr');
                    trDetail.id = `detail-${rowId}`;
                    trDetail.style.display = 'none';
                    trDetail.innerHTML = `<td colspan="8" class="detail-cell"><div id="container-${rowId}" style="min-height:100px; padding:20px;">Carregando...</div></td>`;
                    
                    tbody.appendChild(trMain);
                    tbody.appendChild(trDetail);
                });
            });
    }

    function PlotarRotaResumo(awb) {
        if(awb.RotaMap && awb.RotaMap.Origem) {
            const linha = L.polyline([awb.RotaMap.Origem, awb.RotaMap.Destino], { color: GetCorPorCia(awb.CiaAerea), weight: 2, opacity: 0.4, dashArray: '3, 6' });
            linha.awbNumero = awb.Numero; 
            linha.addTo(layerGeral);
        }
    }

    function ToggleTree(numeroAwb, rowId) {
        const trMain = document.getElementById(rowId);
        const trDetail = document.getElementById(`detail-${rowId}`);
        const icon = document.getElementById(`icon-${rowId}`);
        const container = document.getElementById(`container-${rowId}`);
        
        document.querySelectorAll('[id^="detail-"]').forEach(el => { if(el.id !== `detail-${rowId}`) el.style.display = 'none'; });
        document.querySelectorAll('.row-main').forEach(el => { if(el.id !== rowId) el.classList.remove('active'); });

        if (trDetail.style.display === 'none') {
            trMain.classList.add('active');
            trDetail.style.display = 'table-row';
            icon.style.transform = 'rotate(90deg)';
            FocarRotaNoMapa(numeroAwb);
            fetch(`{{ url_for('Acompanhamento.ApiHistorico', numero_awb='') }}${encodeURIComponent(numeroAwb)}`)
                .then(res => res.json())
                .then(resp => {
                    RenderizarTimeline(resp, container);
                    DesenharRotaReal(resp, numeroAwb);
                });
        } else {
            trMain.classList.remove('active');
            trDetail.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
            ResetarMapaVisual();
        }
    }

    function RenderizarTimeline(data, container) {
        const historico = data.Historico || [];
        if(historico.length === 0) { container.innerHTML = `Sem histórico.`; return; }

        let html = `<div class="timeline-container">`;
        historico.forEach((h, index) => {
            let statusClass = index === 0 && !h.Status.includes('ENTREGUE') ? 'active' : 'completed';
            
            // --- VOO NA TIMELINE TAMBÉM CLICÁVEL ---
            let vooDisplay = '';
            if(h.Voo && h.Voo.length > 2) {
                vooDisplay = `<span class="voo-interativo" style="background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:4px;"
                              ondblclick="AbrirModalVoo('${h.Voo}', '${h.Data}', event)">
                              <i class="ph-airplane-tilt"></i> ${h.Voo}</span>`;
            }

            html += `
                <div class="tl-item" style="display:flex; gap:20px; padding-bottom:20px; position:relative;">
                    <div style="position:absolute; left:7px; top:20px; bottom:0; width:2px; background:#e2e8f0;"></div>
                    <div style="width:16px; height:16px; border-radius:50%; background:${statusClass === 'active' ? '#fff' : '#10b981'}; border:2px solid ${statusClass === 'active' ? '#f59e0b' : '#10b981'}; z-index:2;"></div>
                    <div style="flex:1;">
                        <div style="font-weight:700; color:#1e293b;">${h.Status}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${h.Data}</div>
                        <div style="margin-top:6px; font-size:0.8rem; display:flex; gap:12px;">
                            <span style="background:#f1f5f9; padding:2px 8px; border-radius:4px;"><i class="ph-map-pin"></i> ${h.Local}</span>
                            ${vooDisplay}
                        </div>
                    </div>
                </div>`;
        });
        html += `</div>`;
        container.innerHTML = html;
    }

    function FocarRotaNoMapa(numeroAwb) {
        layerGeral.eachLayer(l => l.setStyle({ opacity: l.awbNumero === numeroAwb ? 0 : 0.05 }));
        layerFoco.clearLayers();
    }

    function DesenharRotaReal(data, numeroAwb) {
        const trajetos = data.TrajetoCompleto || [];
        const pendente = data.RotaPendente;
        let bounds = [];
        
        const iconDot = (c) => L.divIcon({ html: `<div style="background:${c}; width:12px; height:12px; border:2px solid #fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>` });
        const iconPlane = (c) => L.divIcon({ html: `<div style="background:${c}; width:26px; height:26px; display:flex; align-items:center; justify-content:center; border:2px solid #fff; border-radius:6px;"><i class="ph-fill ph-airplane-tilt" style="color:#fff; font-size:16px;"></i></div>`, iconSize: [26, 26] });

        if(trajetos.length > 0) {
            L.marker(trajetos[0].CoordOrigem, { icon: iconDot('#10b981') }).addTo(layerFoco).bindPopup(`Origem: ${trajetos[0].Origem}`);
            bounds.push(trajetos[0].CoordOrigem);

            trajetos.forEach((leg, idx) => {
                L.polyline([leg.CoordOrigem, leg.CoordDestino], { color: GetCorPorCia(leg.Voo), weight: 4, opacity: 0.9 }).addTo(layerFoco);
                
                if(idx === trajetos.length - 1) {
                    let ic = pendente ? iconPlane('#f59e0b') : iconPlane('#10b981');
                    L.marker(leg.CoordDestino, { icon: ic }).addTo(layerFoco);
                } else {
                    L.marker(leg.CoordDestino, { icon: iconDot('#fff') }).addTo(layerFoco);
                }
                bounds.push(leg.CoordDestino);
            });
        } else if (pendente) {
             L.marker(pendente.CoordOrigem, { icon: iconPlane('#ef4444') }).addTo(layerFoco);
             bounds.push(pendente.CoordOrigem);
        }

        if (pendente) {
            L.polyline([pendente.CoordOrigem, pendente.CoordDestino], { color: '#94a3b8', weight: 3, dashArray: '5, 10' }).addTo(layerFoco);
            L.marker(pendente.CoordDestino, { icon: iconDot('#cbd5e1') }).addTo(layerFoco);
            bounds.push(pendente.CoordDestino);
        }

        if(bounds.length > 0) map.fitBounds(bounds, { padding: [60, 60] });
    }

    function ResetarMapaVisual() {
        layerFoco.clearLayers();
        layerGeral.eachLayer(l => l.setStyle({ opacity: 0.3 }));
        map.setView([-14.2350, -51.9253], 4);
    }

    // --- FUNÇÕES DO MODAL DE VOO ---
    function AbrirModalVoo(numero, dataRef, event) {
        if(event) { event.stopPropagation(); event.preventDefault(); } // Evita abrir a árvore da tabela
        
        const modal = document.getElementById('modal-voo');
        modal.style.display = 'flex'; // Exibe com flex para centralizar
        
        // Limpa dados anteriores
        document.getElementById('mv-numero').innerText = 'BUSCANDO...';
        
        fetch(`{{ url_for('Acompanhamento.ApiDetalhesVooModal') }}?numeroVoo=${numero}&dataRef=${dataRef}`)
            .then(r => r.json())
            .then(resp => {
                if(resp.sucesso) {
                    const d = resp.dados;
                    document.getElementById('mv-cia').innerText = d.Cia;
                    document.getElementById('mv-numero').innerText = `${d.Cia} ${d.Numero}`;
                    document.getElementById('mv-origem').innerText = d.OrigemIata;
                    document.getElementById('mv-origem-nome').innerText = d.OrigemNome;
                    document.getElementById('mv-destino').innerText = d.DestinoIata;
                    document.getElementById('mv-destino-nome').innerText = d.DestinoNome;
                    document.getElementById('mv-data').innerText = d.Data;
                    document.getElementById('mv-saida').innerText = d.HorarioSaida;
                    document.getElementById('mv-chegada').innerText = d.HorarioChegada;
                    // document.getElementById('mv-status').innerText = d.Status;

                    // Estilo do Header baseado na Cia
                    const head = document.getElementById('mv-header');
                    head.className = 'm-header'; // Reset
                    const cia = d.Cia.toUpperCase();
                    if(cia.includes('LATAM') || cia.includes('LA')) head.classList.add('mh-latam');
                    else if(cia.includes('GOL') || cia.includes('G3')) head.classList.add('mh-gol');
                    else if(cia.includes('AZUL') || cia.includes('AD')) head.classList.add('mh-azul');
                    else head.classList.add('mh-default');

                } else {
                    alert(resp.msg || "Detalhes não encontrados.");
                    FecharModalVoo();
                }
            })
            .catch(() => {
                alert("Erro ao buscar detalhes do voo.");
                FecharModalVoo();
            });
    }

    function FecharModalVoo() {
        document.getElementById('modal-voo').style.display = 'none';
    }
</script>
{% endblock %}