{% extends "Base.html" %}

{% block titulo %}Mapa de Escalas | FlightOps{% endblock %}

{% block conteudo %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
    /* --- LAYOUT FULLSCREEN --- */
    body { overflow: hidden; } /* Trava scroll do body */
    
    .map-wrapper {
        position: relative;
        width: 100%;
        height: calc(100vh - 72px); /* Desconta Header */
        background: var(--cor-fundo-principal);
    }

    #mapa-voos { 
        width: 100%; height: 100%; 
        z-index: 1; 
        background: #cad2d3; /* Fallback */
    }

    /* Ajuste Dark Mode para o Mapa (Inversão Inteligente) */
    [data-theme="dark"] .leaflet-layer {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
    }

    /* --- PAINEL DE CONTROLE FLUTUANTE (GLASSMORPHISM) --- */
    .control-panel {
        position: absolute;
        top: 20px; left: 20px;
        width: 380px;
        background: var(--cor-fundo-painel);
        opacity: 0.96;
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--cor-borda);
        box-shadow: var(--sombra-card);
        border-radius: 16px;
        z-index: 1000;
        padding: 24px;
        display: flex; flex-direction: column; gap: 20px;
        transition: all 0.3s ease;
    }

    .panel-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 5px;
    }
    .panel-title {
        font-size: 1.4rem; font-weight: 800; 
        color: var(--cor-texto-principal);
        display: flex; align-items: center; gap: 10px;
    }
    
    /* INPUTS MODERNOS */
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-label { 
        font-size: 0.75rem; font-weight: 700; 
        color: var(--cor-texto-secundario); text-transform: uppercase; letter-spacing: 0.5px; 
    }
    
    .custom-input {
        background: var(--cor-fundo-principal);
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto-principal);
        padding: 10px 14px; border-radius: 8px;
        font-family: 'Inter', sans-serif; font-size: 0.9rem;
        outline: none; transition: 0.2s;
        width: 100%;
    }
    .custom-input:focus { 
        border-color: var(--cor-primaria); 
        box-shadow: 0 0 0 3px rgba(var(--cor-primaria-rgb), 0.1); 
    }

    /* Grid de Datas */
    .date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    /* Grid de Origem/Destino */
    .route-row { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: end; }
    .route-icon { 
        color: var(--cor-texto-secundario); padding-bottom: 12px; font-size: 1.2rem; 
    }

    /* BOTÕES DE AÇÃO */
    .action-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-top: 10px; }
    
    .btn-search {
        background: var(--cor-primaria); color: #fff;
        border: none; padding: 12px; border-radius: 8px;
        font-weight: 600; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    .btn-search:hover { background: var(--cor-primaria-hover); transform: translateY(-2px); }
    
    .btn-clear {
        background: transparent; color: var(--cor-texto-secundario);
        border: 1px solid var(--cor-borda); padding: 12px; border-radius: 8px;
        font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .btn-clear:hover { background: rgba(0,0,0,0.05); color: var(--cor-texto-principal); }

    /* SEARCH BAR (LOCALIZAR) */
    .search-bar-wrapper {
        position: relative;
        margin-top: 10px; padding-top: 20px;
        border-top: 1px solid var(--cor-borda);
    }
    .search-icon {
        position: absolute; left: 12px; top: 43px;
        color: var(--cor-texto-secundario); font-size: 1.1rem;
    }
    .search-input { padding-left: 40px; }

    /* --- POPUPS ESTILIZADOS --- */
    .leaflet-popup-content-wrapper { 
        background: var(--cor-fundo-painel); 
        color: var(--cor-texto-principal); 
        border-radius: 12px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        border: 1px solid var(--cor-borda);
        padding: 0; overflow: hidden;
    }
    .leaflet-popup-tip { background: var(--cor-fundo-painel); border: 1px solid var(--cor-borda); border-top: none; border-left: none; }
    .leaflet-popup-content { margin: 0 !important; min-width: 280px; }

    /* Headers Específicos por Cia */
    .pop-header { 
        padding: 14px 18px; font-weight: 700; color: white;
        display: flex; justify-content: space-between; align-items: center;
        background: #495057; /* Default */
    }
    .header-latam { background: linear-gradient(135deg, #E30613, #b3000b); }
    .header-azul { background: linear-gradient(135deg, #009FE3, #0077aa); }
    .header-gol { background: linear-gradient(135deg, #FF7020, #e05e15); }

    .pop-body { padding: 18px; }
    
    .pop-route-visual {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0,0,0,0.04); border-radius: 8px; padding: 10px 15px;
        margin-bottom: 15px;
    }
    .pop-iata { font-size: 1.4rem; font-weight: 800; color: var(--cor-texto-principal); }
    .pop-arrow { color: var(--cor-texto-secundario); font-size: 1.2rem; }

    .pop-info-row { 
        display: flex; justify-content: space-between; margin-bottom: 8px; 
        border-bottom: 1px dashed var(--cor-borda); padding-bottom: 8px;
    }
    .pop-info-row:last-child { border: none; padding: 0; margin: 0; }
    
    .pop-lbl { font-size: 0.75rem; color: var(--cor-texto-secundario); font-weight: 600; text-transform: uppercase; }
    .pop-val { font-weight: 700; color: var(--cor-texto-principal); font-size: 0.9rem; }

    /* Paginação Popup */
    .pop-footer {
        background: rgba(0,0,0,0.03); padding: 10px 18px;
        display: flex; justify-content: space-between; align-items: center;
        border-top: 1px solid var(--cor-borda);
    }
    .nav-btn {
        background: var(--cor-fundo-painel); border: 1px solid var(--cor-borda);
        width: 28px; height: 28px; border-radius: 6px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        color: var(--cor-texto-principal); transition: 0.2s;
    }
    .nav-btn:hover:not(:disabled) { background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
    .nav-btn:disabled { opacity: 0.4; cursor: default; }
    
    .page-indicator { font-size: 0.8rem; font-weight: 600; color: var(--cor-texto-secundario); }

</style>

<datalist id="lista-aeroportos"></datalist>

<div class="map-wrapper">
    
    <div class="control-panel">
        <div class="panel-header">
            <div class="panel-title">
                <i class="ph-duotone ph-globe-hemisphere-west" style="color: var(--cor-primaria);"></i>
                Escalas
            </div>
        </div>

        <div class="date-row">
            <div class="input-group">
                <label class="input-label">Início</label>
                <input type="date" id="data-inicio" class="custom-input">
            </div>
            <div class="input-group">
                <label class="input-label">Fim</label>
                <input type="date" id="data-fim" class="custom-input">
            </div>
        </div>

        <div class="route-row">
            <div class="input-group">
                <label class="input-label">Origem</label>
                <input type="text" id="filtro-origem" class="custom-input" placeholder="GRU" 
                       list="lista-aeroportos" style="text-transform: uppercase; text-align: center; font-weight: 700;">
            </div>
            <div class="route-icon">
                <i class="ph-bold ph-arrow-right"></i>
            </div>
            <div class="input-group">
                <label class="input-label">Destino</label>
                <input type="text" id="filtro-destino" class="custom-input" placeholder="MIA" 
                       list="lista-aeroportos" style="text-transform: uppercase; text-align: center; font-weight: 700;">
            </div>
        </div>

        <div class="action-row">
            <button class="btn-search" onclick="CarregarMapa()">
                <i class="ph-bold ph-magnifying-glass"></i> Buscar Rotas
            </button>
            <button class="btn-clear" onclick="LimparFiltros()">
                <i class="ph-bold ph-trash"></i>
            </button>
        </div>

        <div class="search-bar-wrapper">
            <div class="input-group">
                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                    <i class="ph-bold ph-map-pin" style="color: var(--cor-primaria); font-size: 1.1rem;"></i>
                    <label class="input-label" style="margin-bottom: 0;">Localizar Aeroporto</label>
                </div>
                
                <input type="text" id="input-localizar" class="custom-input" 
                       list="lista-aeroportos" placeholder="Digite IATA ou Nome..." 
                       onchange="LocalizarAeroporto(this.value)">
            </div>
        </div>
    </div>

    <div id="mapa-voos"></div>
</div>

<script>
    // --- ROTAS DA API ---
    const API_URLS = {
        listarAeroportos: "{{ url_for('Aeroporto.ApiListarSimples') }}",
        buscarRotas: "{{ url_for('Malha.ApiRotas') }}"
    };

    // --- GLOBAIS ---
    let map, flightLayer, layerAeroportos;
    let rotasAgrupadas = {}; 
    let baseAeroportos = []; 
    let cacheAeroportosData = null; 
    let lastInicio = null, lastFim = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        InicializarMapa();
    });

    function InicializarMapa() {
        if (map) return;

        map = L.map('mapa-voos', { zoomControl: false }).setView([-15.79, -47.88], 4);
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; FlightOps', maxZoom: 19
        }).addTo(map);

        layerAeroportos = L.layerGroup().addTo(map);
        flightLayer = L.layerGroup().addTo(map);

        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('data-inicio').value = hoje;
        document.getElementById('data-fim').value = hoje;
        
        CarregarListaAeroportos();
        CarregarMapa();
    }

    async function CarregarListaAeroportos() {
        try {
            const resp = await fetch(API_URLS.listarAeroportos);
            baseAeroportos = await resp.json();
            const datalist = document.getElementById('lista-aeroportos');
            datalist.innerHTML = '';
            baseAeroportos.forEach(aero => {
                const option = document.createElement('option');
                option.value = aero.iata; 
                option.label = `${aero.nome} (${aero.iata})`;
                datalist.appendChild(option);
            });
        } catch (e) { console.error("Erro lista aeroportos", e); }
    }

    function LocalizarAeroporto(iataInput) {
        if (!iataInput) return;
        document.getElementById('input-localizar').value = '';
        document.getElementById('input-localizar').blur();

        const iata = iataInput.toUpperCase().trim();
        const aero = baseAeroportos.find(a => a.iata === iata);

        if (aero) {
            map.flyTo([aero.lat, aero.lon], 12, { duration: 1.5 });
            L.popup().setLatLng([aero.lat, aero.lon])
                .setContent(`<div style="padding:10px; font-weight:700;">${aero.iata} - ${aero.nome}</div>`).openOn(map);
        }
    }

    async function CarregarMapa() {
        const inicio = document.getElementById('data-inicio').value;
        const fim = document.getElementById('data-fim').value;
        const origem = document.getElementById('filtro-origem').value;
        const destino = document.getElementById('filtro-destino').value;

        if(!inicio || !fim) return alert("Selecione o período.");

        if (inicio !== lastInicio || fim !== lastFim || !cacheAeroportosData) {
            await CarregarAeroportosFundo(inicio, fim);
            lastInicio = inicio; lastFim = fim;
        }
        
        flightLayer.clearLayers();
        rotasAgrupadas = {}; 

        try {
            let url = `${API_URLS.buscarRotas}?inicio=${inicio}&fim=${fim}`;
            if(origem) url += `&origem=${origem}`;
            if(destino) url += `&destino=${destino}`;

            const response = await fetch(url);
            const dadosBrutos = await response.json();

            if (dadosBrutos.length === 0) { alert("Nenhuma rota encontrada."); return; }

            dadosBrutos.forEach(voo => {
                const chave = `${voo.origem.iata}-${voo.destino.iata}`;
                if (!rotasAgrupadas[chave]) rotasAgrupadas[chave] = [];
                rotasAgrupadas[chave].push(voo);
            });

            Object.keys(rotasAgrupadas).forEach(chave => {
                const grupo = rotasAgrupadas[chave];
                const vooPrincipal = grupo.find(v => v.cia.includes('GOL')) || grupo[0];
                
                const p1 = [vooPrincipal.origem.lat, vooPrincipal.origem.lon];
                const p2 = [vooPrincipal.destino.lat, vooPrincipal.destino.lon];
                const estilo = ObterEstiloVoo(vooPrincipal.cia, vooPrincipal.tipo_resultado);
                
                let linha;
                if (estilo.isZebra) {
                    L.polyline([p1, p2], { color: 'white', weight: estilo.weight+2, opacity: estilo.opacity }).addTo(flightLayer);
                    linha = L.polyline([p1, p2], { color: estilo.color, weight: estilo.weight, opacity: estilo.opacity, dashArray: estilo.dashArray }).addTo(flightLayer);
                } else {
                    linha = L.polyline([p1, p2], { color: estilo.color, weight: estilo.weight, opacity: estilo.opacity }).addTo(flightLayer);
                }

                linha.bindPopup(GerarHtmlPopup(chave, 0));
                
                if (vooPrincipal.tipo_resultado !== 'Geral') {
                    L.circleMarker(p1, { radius: 4, color: estilo.color, fillColor: '#fff', fillOpacity: 1 }).addTo(flightLayer);
                    L.circleMarker(p2, { radius: 4, color: estilo.color, fillColor: '#fff', fillOpacity: 1 }).addTo(flightLayer);
                }
            });

            if (dadosBrutos.length > 0) {
                const bounds = L.latLngBounds(dadosBrutos.map(r => [r.origem.lat, r.origem.lon]).concat(dadosBrutos.map(r => [r.destino.lat, r.destino.lon])));
                map.fitBounds(bounds, { padding: [100, 100] });
            }

        } catch (error) { console.error(error); }
    }

    // --- POPUP REFINADO (HTML) ---
    function GerarHtmlPopup(chaveRota, index) {
        const grupo = rotasAgrupadas[chaveRota];
        const voo = grupo[index];
        const total = grupo.length;
        const estilo = ObterEstiloVoo(voo.cia, voo.tipo_resultado);
        const nomeOrigem = voo.origem.nome ? voo.origem.nome.replace('International Airport', '').replace('Airport', '') : '';
        const nomeDestino = voo.destino.nome ? voo.destino.nome.replace('International Airport', '').replace('Airport', '') : '';

        return `
            <div id="popup-content-${chaveRota}">
                <div class="pop-header ${estilo.headerClass}">
                    <span>${voo.cia} ${voo.voo}</span>
                    <i class="ph-fill ph-airplane-tilt"></i>
                </div>
                <div class="pop-body">
                    <div class="pop-route-visual">
                        <span class="pop-iata">${voo.origem.iata}</span>
                        <i class="ph-bold ph-arrow-right pop-arrow"></i>
                        <span class="pop-iata">${voo.destino.iata}</span>
                    </div>
                    <div class="pop-info-row"><span class="pop-lbl">Partida</span><span class="pop-val">${voo.horario_saida}</span></div>
                    <div class="pop-info-row"><span class="pop-lbl">Chegada</span><span class="pop-val">${voo.horario_chegada}</span></div>
                    <div class="pop-info-row"><span class="pop-lbl">Data</span><span class="pop-val">${voo.data}</span></div>
                </div>
                ${total > 1 ? `
                <div class="pop-footer">
                    <button type="button" class="nav-btn" ${index===0?'disabled':''} onclick="NavegarPopup(event, '${chaveRota}', ${index-1})"><i class="ph-bold ph-caret-left"></i></button>
                    <span class="page-indicator">Voo ${index+1} de ${total}</span>
                    <button type="button" class="nav-btn" ${index===(total-1)?'disabled':''} onclick="NavegarPopup(event, '${chaveRota}', ${index+1})"><i class="ph-bold ph-caret-right"></i></button>
                </div>` : ''}
            </div>
        `;
    }

    window.NavegarPopup = function(event, chaveRota, novoIndex) {
        if (event) { event.stopPropagation(); event.preventDefault(); }
        const novoHtml = GerarHtmlPopup(chaveRota, novoIndex);
        if (map._popup) map._popup.setContent(novoHtml);
    };

    // --- ESTILOS VISUAIS ---
    function ObterEstiloVoo(cia, tipo) {
        const nome = cia ? String(cia).toUpperCase().trim() : '';
        let c='#495057', z=false, h='header-default';
        if (nome.includes('LATAM') || nome === 'JJ' || nome === 'LA') { c='#E30613'; h='header-latam'; }
        else if (nome.includes('AZUL') || nome === 'AD') { c='#009FE3'; h='header-azul'; }
        else if (nome.includes('GOL') || nome === 'G3') { c='#FF7020'; z=true; h='header-gol'; }
        
        if (tipo === 'Geral') return { color: c, weight: 1.5, opacity: 0.3, dashArray: null, isZebra: false, headerClass: h };
        return { color: c, weight: 4, opacity: 1, dashArray: z?'12,12':null, isZebra: z, headerClass: h };
    }

    async function CarregarAeroportosFundo(inicio, fim) {
        layerAeroportos.clearLayers();
        try {
            const r = await fetch(`${API_URLS.buscarRotas}?inicio=${inicio}&fim=${fim}`);
            const t = await r.json();
            const u = new Set();
            t.forEach(rota => {
                if(!u.has(rota.origem.iata)) { u.add(rota.origem.iata); DesenharPonto(rota.origem); }
                if(!u.has(rota.destino.iata)) { u.add(rota.destino.iata); DesenharPonto(rota.destino); }
            });
            cacheAeroportosData = true;
        } catch(e){}
    }
    
    function DesenharPonto(a) {
        L.circleMarker([a.lat, a.lon], { radius:3, color:'#ced4da', weight:1, fillColor:'#e9ecef', fillOpacity:0.6 })
         .bindTooltip(a.iata, { permanent:false, direction:'top', className: 'tooltip-aero' }).addTo(layerAeroportos);
    }

    function LimparFiltros() {
        document.getElementById('filtro-origem').value = '';
        document.getElementById('filtro-destino').value = '';
        CarregarMapa();
    }
</script>
{% endblock %}