name: Deploy Automatico T-FlightOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código atualizado
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      # Passamos as variaveis do Git para o PowerShell
      env:
        COMMIT_MSG: ${{ github.event.head_commit.message }}
        COMMIT_AUTHOR: ${{ github.actor }}
      run: |
        # --- CONFIGURAÇÕES ---
        $ServiceName = "Luft-FlightOps"
        $AppPath = "C:\ProjetosPython\T-FlightOps"
        $LogFile = "C:\actions-runner\deploy-log.txt"
        
        # Inicia Log
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- DEPLOY (MODO WINDOWS) INICIADO: $(Get-Date) ---"

        $ErrorActionPreference = "Continue"

        # -----------------------------------------------------------
        # 1. PARAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "1. Parando serviço $ServiceName..."
        cmd /c "net stop $ServiceName /y" 2>&1 | Out-Null
        Start-Sleep -Seconds 5

        # -----------------------------------------------------------
        # 2. LIMPEZA
        # -----------------------------------------------------------
        Write-Host "2. Limpando arquivos antigos..."
        if (Test-Path $AppPath) {
            Get-ChildItem -Path $AppPath -Exclude ".venv", ".git", ".env" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        } else {
            New-Item -ItemType Directory -Force -Path $AppPath
        }

        # -----------------------------------------------------------
        # 3. COPIA
        # -----------------------------------------------------------
        Write-Host "3. Copiando arquivos..."
        Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git", ".github"
        
        if (-not (Test-Path "$AppPath\WSGI.py")) {
            Write-Error "ERRO FATAL: O arquivo WSGI.py não foi copiado."
            Stop-Transcript; exit 1
        }

        # -----------------------------------------------------------
        # 4. INSTALAÇÃO (PIP)
        # -----------------------------------------------------------
        Write-Host "4. Instalando dependências..."
        Set-Location $AppPath
        if (Test-Path ".venv\Scripts\python.exe") {
            cmd /c ".\.venv\Scripts\python.exe -m pip install -r requirements.txt"
            
            if ($LASTEXITCODE -ne 0) {
                Write-Error "ERRO FATAL: Falha no PIP. Código: $LASTEXITCODE"
                Stop-Transcript; exit 1
            }

            # -----------------------------------------------------------
            # 4.1 REGISTRAR NOVA VERSÃO (NOVO!)
            # -----------------------------------------------------------
            Write-Host "4.1 Registrando Versão no Banco..."
            
            # Lê o arquivo VERSION da raiz (Crie este arquivo com o número, ex: 1.0.1)
            if (Test-Path "VERSION") {
                $VersionNum = Get-Content "VERSION" -Raw
                $VersionNum = $VersionNum.Trim() # Remove espaços extras
                
                # Limpa aspas da mensagem de commit para não quebrar o comando
                $CleanMsg = $env:COMMIT_MSG -replace '"', ''
                $Author = $env:COMMIT_AUTHOR

                # Roda o script Python usando a venv
                cmd /c ".\.venv\Scripts\python.exe Scripts/GestaoVersao.py nova --numero `"$VersionNum`" --estagio `"Alpha`" --msg `"$CleanMsg`" --dev `"$Author`""
                
                Write-Host "Versão $VersionNum registrada."
            } else {
                Write-Warning "Arquivo VERSION não encontrado. Pulei o registro de versão."
            }

        } else {
            Write-Error "ERRO FATAL: .venv não encontrada!"
            Stop-Transcript; exit 1
        }

        # -----------------------------------------------------------
        # 5. INICIAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "5. Iniciando serviço $ServiceName..."
        cmd /c "net start $ServiceName"
        Start-Sleep -Seconds 5
        
        $ServiceStatus = Get-Service $ServiceName
        if ($ServiceStatus.Status -ne 'Running') {
            Write-Warning "ALERTA: O serviço não está 'Running'."
        } else {
            Write-Host "Serviço iniciado com sucesso!"
        }

        # -----------------------------------------------------------
        # 6. REINICIAR NGINX
        # -----------------------------------------------------------
        Write-Host "6. Reiniciando Nginx..."
        cmd /c "net stop Nginx && net start Nginx" 2>&1 | Out-Null
        
        Write-Host "--- DEPLOY CONCLUÍDO ---"
        Stop-Transcript