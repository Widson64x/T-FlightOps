name: Deploy Automatico T-FlightOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código atualizado
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      run: |
        # --- CONFIGURAÇÕES ---
        $ServiceName = "Luft-FlightOps"  # <--- ESSA LINHA ERA A QUE FALTAVA!
        $AppPath = "C:\ProjetosPython\T-FlightOps"
        $LogFile = "C:\actions-runner\deploy-log.txt"
        
        # Inicia Log
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- DEPLOY (MODO WINDOWS) INICIADO: $(Get-Date) ---"

        # Garante que erros de comando não matem o script (checagem manual)
        $ErrorActionPreference = "Continue"

        # -----------------------------------------------------------
        # 1. PARAR SERVIÇO (Usando NET STOP)
        # -----------------------------------------------------------
        Write-Host "1. Parando serviço $ServiceName..."
        # O 'net stop' é nativo do Windows. O '2>&1' evita erros falsos no log.
        cmd /c "net stop $ServiceName /y" 2>&1 | Out-Null
        
        # Espera forçada para garantir que o arquivo soltou
        Start-Sleep -Seconds 5

        # -----------------------------------------------------------
        # 2. LIMPEZA
        # -----------------------------------------------------------
        Write-Host "2. Limpando arquivos antigos..."
        if (Test-Path $AppPath) {
            # Limpa tudo menos .venv, .git e .env
            Get-ChildItem -Path $AppPath -Exclude ".venv", ".git", ".env" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        } else {
            New-Item -ItemType Directory -Force -Path $AppPath
        }

        # -----------------------------------------------------------
        # 3. COPIA
        # -----------------------------------------------------------
        Write-Host "3. Copiando arquivos..."
        Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git", ".github"
        
        # Verifica se o arquivo principal está lá
        if (-not (Test-Path "$AppPath\WSGI.py")) {
            Write-Error "ERRO FATAL: O arquivo WSGI.py não foi copiado."
            Stop-Transcript
            exit 1
        }

        # -----------------------------------------------------------
        # 4. INSTALAÇÃO (PIP)
        # -----------------------------------------------------------
        Write-Host "4. Instalando dependências..."
        Set-Location $AppPath
        if (Test-Path ".venv\Scripts\python.exe") {
            # Executa pip ignorando avisos amarelos (warnings)
            cmd /c ".\.venv\Scripts\python.exe -m pip install -r requirements.txt"
            
            # Só para se o código de saída for de erro real
            if ($LASTEXITCODE -ne 0) {
                Write-Error "ERRO FATAL: Falha no PIP. Código: $LASTEXITCODE"
                Stop-Transcript
                exit 1
            }
        } else {
            Write-Error "ERRO FATAL: .venv não encontrada!"
            Stop-Transcript
            exit 1
        }

        # -----------------------------------------------------------
        # 5. INICIAR SERVIÇO (Usando NET START)
        # -----------------------------------------------------------
        Write-Host "5. Iniciando serviço $ServiceName..."
        cmd /c "net start $ServiceName"
        
        Start-Sleep -Seconds 5
        
        # Verifica status
        $ServiceStatus = Get-Service $ServiceName
        if ($ServiceStatus.Status -ne 'Running') {
            Write-Warning "ALERTA: O serviço não está 'Running'. Status atual: $($ServiceStatus.Status)"
        } else {
            Write-Host "Serviço iniciado com sucesso!"
        }

        # -----------------------------------------------------------
        # 6. REINICIAR NGINX
        # -----------------------------------------------------------
        Write-Host "6. Reiniciando Nginx..."
        # Reinicia o Nginx usando comandos nativos também
        cmd /c "net stop Nginx && net start Nginx" 2>&1 | Out-Null
        
        Write-Host "--- DEPLOY CONCLUÍDO ---"
        Stop-Transcript