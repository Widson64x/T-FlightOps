name: Deploy Automatico T-FlightOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código atualizado
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      run: |
        # --- CONFIGURAÇÃO DE LOG ---
        $LogFile = "C:\actions-runner\deploy-log.txt"
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- NOVO DEPLOY INICIADO: $(Get-Date) ---"

        # Ativa modo estrito globalmente (para parar se der erro grave)
        $ErrorActionPreference = "Stop"

        try {
            # --- SEUS CAMINHOS ---
            $ServiceName = "Luft-FlightOps"
            $AppPath = "C:\ProjetosPython\T-FlightOps"
            $nssmPath = "C:\nssm-2.24\win64\nssm.exe"

            # 1. Parar o serviço Python
            Write-Host "1. Parando serviço $ServiceName..."
            if (Get-Service $ServiceName -ErrorAction SilentlyContinue) {
                # Usamos cmd /c e ignoramos erro aqui para garantir que pare
                cmd /c "$nssmPath stop $ServiceName" 2>&1 | Out-Null
                Start-Sleep -Seconds 5
            } else {
                Write-Host "Serviço não estava rodando."
            }

            # 2. Limpar a pasta (Protegendo .venv e .git)
            Write-Host "2. Limpando arquivos antigos..."
            if (Test-Path $AppPath) {
                Get-ChildItem -Path $AppPath -Exclude ".venv", ".git" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            } else {
                New-Item -ItemType Directory -Force -Path $AppPath
            }

            # 3. Copiar os arquivos novos
            Write-Host "3. Copiando nova versão..."
            Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git", ".github"

            # 4. Instalar dependências (SOLUÇÃO BLINDADA)
            Write-Host "4. Instalando bibliotecas (pip)..."
            Set-Location $AppPath
            
            if (Test-Path ".venv\Scripts\python.exe") {
                # --- TRUQUE: Relaxar a verificação de erro só para o PIP ---
                $OldPreference = $ErrorActionPreference
                $ErrorActionPreference = "Continue"

                # Executa redirecionando o fluxo de erro para o fluxo normal (2>&1)
                # O '| Write-Host' garante que o texto apareça no log mas não seja tratado como exceção
                & .\.venv\Scripts\python.exe -m pip install -r requirements.txt 2>&1 | Write-Host

                # Verifica se houve erro REAL (código de saída diferente de 0)
                if ($LASTEXITCODE -ne 0) { 
                    throw "O PIP falhou com código de erro: $LASTEXITCODE" 
                }

                # Restaura a verificação estrita
                $ErrorActionPreference = $OldPreference
            } else {
                throw "A pasta .venv não existe em $AppPath! O deploy falhou."
            }

            # 5. Reiniciar Serviço Python
            Write-Host "5. Iniciando serviço $ServiceName..."
            # Relaxa erro aqui também, pois o NSSM às vezes solta texto na saída de erro
            $ErrorActionPreference = "Continue"
            & $nssmPath start $ServiceName 2>&1 | Write-Host
            $ErrorActionPreference = "Stop"

            # 6. Reiniciar Nginx
            Write-Host "6. Reiniciando Nginx..."
            Restart-Service "nginx" -ErrorAction Continue

            Write-Host "--- DEPLOY CONCLUÍDO COM SUCESSO ---"
        
        } catch {
            Write-Error "!!! ERRO FATAL DURANTE O DEPLOY !!!"
            Write-Error $_
            Write-Error $_.ScriptStackTrace
            exit 1
        } finally {
            Write-Host "--- FIM DO LOG ---"
            Stop-Transcript
        }